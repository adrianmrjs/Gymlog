<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="GYMLOG">
<title>GYMLOG</title>

<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">

<style>
/* --- 1. VARIABLES & RESET --- */
:root {
    --bg-body: #000000;
    --bg-app: #0f172a;
    --surface: #1e293b;
    --surface-hover: #334155; 
    --primary: #6366f1;
    --text-main: #f8fafc;
    --text-muted: #94a3b8;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --radius: 16px;
    --app-width: 460px;
    --safe-area-bottom: env(safe-area-inset-bottom);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body { 
    margin: 0; background-color: var(--bg-body); color: var(--text-main); 
    font-family: 'Inter', sans-serif; font-size: 14px;
    display: flex; justify-content: center; min-height: 100vh;
}

.app-container {
    width: 100%; max-width: var(--app-width); background-color: var(--bg-app);
    min-height: 100vh; position: relative; 
    box-shadow: 0 0 50px rgba(255,255,255,0.05);
    overflow-x: hidden; 
    padding-bottom: calc(100px + var(--safe-area-bottom));
    padding-top: env(safe-area-inset-top);
}

/* --- 2. COMPONENTES UI --- */
h1 { font-size: 22px; font-weight: 800; margin: 0; letter-spacing: -0.5px; }
h2 { font-size: 18px; font-weight: 700; margin: 0; }
small { color: var(--text-muted); font-size: 12px; }

/* Botones */
.btn {
    background: var(--primary); color: white; border: none; padding: 14px; border-radius: var(--radius);
    font-weight: 700; font-size: 15px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px;
    width: 100%; transition: transform 0.1s; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
    text-decoration: none;
}
.btn:active { transform: scale(0.97); }
.btn.icon { width: 40px; height: 40px; padding: 0; border-radius: 50%; background: rgba(255,255,255,0.05); box-shadow: none; color: white; border: none; display: flex; align-items: center; justify-content: center;}
.btn.small { padding: 8px 12px; font-size: 12px; width: auto; background: transparent; border: 1px dashed var(--surface-hover); color: var(--primary); box-shadow: none; }
.btn.text { background: none; box-shadow: none; padding: 8px; width: auto; color: var(--text-muted); font-size: 14px; }
.btn.danger { background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); color: var(--danger); box-shadow: none; }
.btn.yt { background: rgba(239, 68, 68, 0.15); border: 1px solid #ef4444; color: #ef4444; padding: 4px 8px; border-radius: 6px; font-size: 10px; margin-left: 8px; display: inline-flex; width: auto; box-shadow: none; height: auto; }

/* Boton de acci√≥n principal (Verde) */
.btn.action-green { background: var(--success); color: #022c22; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); }
.btn.action-green i { font-size: 24px; font-weight: bold; }

/* Tarjetas */
.card { background: var(--surface); border-radius: var(--radius); padding: 16px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.03); }

/* --- 3. INPUTS & CHECKBOXES --- */
input[type="number"], input[type="text"], select { 
    background: #020617; border: 1px solid var(--surface-hover); color: white; 
    padding: 10px; border-radius: 8px; text-align: center; width: 100%; 
    font-size: 16px; font-weight: 600; outline: none; font-family: inherit;
}
input:focus, select:focus { border-color: var(--primary); }

/* Checkbox Calentamiento */
.warmup-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
.warmup-item:last-child { border-bottom: none; }
input[type="checkbox"].native-check { appearance: auto; width: 24px; height: 24px; margin: 0; accent-color: var(--success); cursor: pointer; }

/* Checkbox Series */
.check-btn { width: 100%; height: 42px; border-radius: 8px; background: #020617; border: 1px solid var(--surface-hover); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
.check-btn.checked { background: var(--success); border-color: var(--success); }
.check-btn i { opacity: 0; transform: scale(0.5); transition: 0.2s; color: #022c22; font-weight: bold; font-size: 20px; }
.check-btn.checked i { opacity: 1; transform: scale(1); }

/* --- 4. GRILLAS --- */
.sets-header { display: grid; gap: 8px; font-size: 10px; color: var(--text-muted); text-align: center; margin-bottom: 6px; font-weight: 700; padding: 0 2px; }
.set-row { margin-bottom: 8px; align-items: center; display: grid; gap: 8px; }
.grid-weighted { grid-template-columns: 30px 1fr 1fr 44px; }
.grid-simple { grid-template-columns: 30px 1fr 44px; }
.set-num { text-align: center; color: var(--text-muted); font-weight: 600; font-size: 12px; }

/* --- 5. EXTRAS --- */
.flex-between { display: flex; justify-content: space-between; align-items: center; }
.hidden { display: none !important; }
.tag { padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 800; text-transform: uppercase; }
.tag.blue { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
.divider-title { margin: 20px 0 10px; font-size: 12px; color: var(--text-muted); letter-spacing: 1px; font-weight: 800; text-transform: uppercase; border-bottom: 1px solid var(--surface-hover); padding-bottom: 5px; }

/* Sync Badge */
.sync-badge { background: rgba(16, 185, 129, 0.2); color: #34d399; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; display: flex; align-items: center; gap: 6px; cursor: pointer; border: 1px solid rgba(16, 185, 129, 0.3); }
.sync-badge.pending { background: rgba(245, 158, 11, 0.2); color: #fbbf24; border-color: rgba(245, 158, 11, 0.3); }
.sync-badge.error { background: rgba(239, 68, 68, 0.2); color: #f87171; border-color: rgba(239, 68, 68, 0.3); }
.sync-spin { animation: spin 1s linear infinite; } @keyframes spin { 100% { transform: rotate(360deg); } }

/* ‚ö†Ô∏è ARREGLO DE ANIMACI√ìN PARA EVITAR SALTO DE MEN√ö ‚ö†Ô∏è */
.screen { display: none; padding: 20px; animation: fadeIn 0.2s ease-in-out; }
.screen.active { display: block; }
@keyframes fadeIn { 
    from { opacity: 0; } 
    to { opacity: 1; } 
}

/* Timer */
.timer-float { position: fixed; bottom: calc(90px + var(--safe-area-bottom)); right: 20px; left: 20px; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 16px; padding: 12px 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 200; }

/* Calendario */
.cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; margin-top: 10px; }
.cal-day-label { color: var(--text-muted); font-size: 10px; font-weight: bold; margin-bottom: 5px; }
.cal-day { aspect-ratio: 1/1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 10px; font-size: 13px; cursor: pointer; position: relative; border: 1px solid transparent; background: rgba(255,255,255,0.02); }
.cal-day.today { border-color: var(--primary); color: var(--primary); font-weight: bold; }
.cal-day.selected { background: var(--primary) !important; color: white !important; border-color: transparent; }
.cal-day.has-workout::after { content: ''; position: absolute; bottom: 4px; width: 4px; height: 4px; background-color: var(--success); border-radius: 50%; }
.cal-day.selected.has-workout::after { background-color: white; }

/* Historial */
.hist-ex-title { color: var(--primary); font-weight: 700; font-size: 14px; margin-bottom: 6px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 4px; }
.hist-set-row { display: flex; justify-content: space-between; font-size: 13px; color: #cbd5e1; margin-bottom: 4px; padding: 4px 8px; background: rgba(0,0,0,0.2); border-radius: 6px; }

/* Editor */
.editor-item-card { margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1); }
.editor-input-group { display: grid; grid-template-columns: 2fr 1fr; gap: 8px; margin-bottom: 8px; }

/* --- NAVEGACI√ìN --- */

/* Nav Principal (Flotante) */
.nav { 
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
    width: 90%; max-width: 440px; 
    background: rgba(30, 41, 59, 0.9); backdrop-filter: blur(12px); 
    border-radius: 24px; padding: 12px 40px; 
    display: flex; justify-content: space-between; align-items: center; 
    border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.6); 
    z-index: 1000; 
}
.nav-item { background: none; border: none; color: var(--text-muted); font-size: 10px; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
.nav-item.active { color: var(--primary); } .nav-item i { font-size: 22px; }

/* BARRA DE ACCI√ìN INFERIOR (Fixed & Centrada) */
.bottom-action-bar {
    position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
    width: 100%; max-width: var(--app-width); /* Mismo ancho que la app */
    background: rgba(15, 23, 42, 0.98); 
    backdrop-filter: blur(10px);
    border-top: 1px solid rgba(255,255,255,0.1);
    padding: 12px 25px;
    padding-bottom: calc(12px + var(--safe-area-bottom));
    display: flex; justify-content: space-between; align-items: center;
    z-index: 1000;
    box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
}
</style>
</head>
<body>

<script>
    // ‚ö†Ô∏è REEMPLAZA ESTO CON TU URL DE GOOGLE APPS SCRIPT ‚ö†Ô∏è
    const API_URL = "https://script.google.com/macros/s/AKfycbwcqHNwPq6JReM8BJMAvyhuo2JhsVrNJeDj64TQBplxpF6SDkFkvPeCiSAHz564OGqG/exec"; 
</script>

<div id="rest-timer" class="timer-float hidden">
    <div class="flex-between">
        <div><small>Descanso</small><div id="timer-countdown" style="font-weight:800;font-size:24px;color:white">01:30</div></div>
        <div class="flex-between" style="gap:10px">
            <button class="btn small" style="width:40px;height:40px;border-radius:50%;border:1px solid rgba(255,255,255,0.2);color:white" onclick="addTime(30)">+30</button>
            <button class="btn small" style="width:40px;height:40px;border-radius:50%;border-color:#f87171;color:#f87171" onclick="stopTimer()"><i class="ri-stop-fill"></i></button>
        </div>
    </div>
</div>

<div class="app-container">

    <div id="home" class="screen active">
        <div class="flex-between" style="margin-bottom:20px">
            <div><small>Bienvenido</small><h1>Hola, Atleta ‚ö°</h1></div>
            <div id="sync-status" class="sync-badge" onclick="forceSync()">
                <i class="ri-cloud-line"></i> <span>Sync</span>
            </div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:15px">
            <div class="card" style="margin:0; padding:12px; text-align:center">
                <div id="current-weight-display" style="color:var(--success);font-weight:800;font-size:16px">--</div><small>Peso</small>
            </div>
            <div class="card" style="margin:0; padding:12px; text-align:center">
                <div style="color:white;font-weight:800;font-size:16px">78 kg</div><small>Meta</small>
            </div>
            <div class="card" style="margin:0; padding:12px; text-align:center">
                <div id="total-sessions" style="color:var(--primary);font-weight:800;font-size:16px">0</div><small>Sesiones</small>
            </div>
        </div>

        <div class="card" style="border:1px solid rgba(16,185,129,0.2); background: #0b1221">
            <div class="flex-between" style="margin-bottom:15px">
                <strong style="color:#6ee7b7"><i class="ri-line-chart-line"></i> Progreso Peso</strong>
                <small id="last-weight-date" style="color:#a7f3d0">--</small>
            </div>
            <div style="height:120px; width:100%"><canvas id="weightChart"></canvas></div>
            <div class="flex-between" style="gap:10px; border-top:1px solid rgba(255,255,255,0.05); padding-top:15px; margin-top:10px">
                <input type="number" id="input-bodyweight" placeholder="Nuevo peso (kg)" style="text-align:left">
                <button class="btn small" style="background:#10b981; color:black; border:none; width:auto" onclick="saveBodyWeight()">Guardar</button>
            </div>
        </div>

        <div class="flex-between" style="margin:25px 0 10px">
            <h3 style="margin:0; color:var(--text-muted); font-size:12px; letter-spacing:1px">RUTINAS</h3>
            <button class="btn small" onclick="go('editor')" style="border:none; color:var(--primary)"><i class="ri-edit-box-line"></i> Editar</button>
        </div>
        <div id="routines-list"></div>
        <button class="btn text" onclick="resetApp()" style="margin: 30px auto; display:block; font-size:12px; opacity:0.5">Resetear App</button>
    </div>

    <div id="training" class="screen" style="padding-bottom:100px; padding-top:20px">
        <h2 id="active-title" style="text-align:center; margin-bottom:20px; font-size:20px;">Rutina</h2>
        <div class="card" style="border-left:3px solid var(--warning); background:rgba(245,158,11,0.05)">
            <div class="flex-between" onclick="document.getElementById('warmup-items').classList.toggle('hidden')" style="cursor:pointer">
                <strong>üî• Calentamiento</strong> <i class="ri-arrow-down-s-line"></i>
            </div>
            <div id="warmup-items" class="hidden" style="margin-top:10px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.1)"></div>
        </div>
        <div id="workout-container"></div>
        
        <div class="bottom-action-bar">
            <button class="btn icon" style="width:50px; height:50px; background:rgba(255,255,255,0.1);" onclick="cancelWorkout()"><i class="ri-arrow-left-line" style="font-size:24px;"></i></button>
            <button class="btn icon action-green" style="width:60px; height:60px;" onclick="finishWorkout()"><i class="ri-check-double-line"></i></button>
        </div>
    </div>

    <div id="history" class="screen">
        <div class="flex-between" style="margin-bottom:15px">
            <h2>Calendario</h2>
            <button class="btn small" onclick="downloadData()" style="width:auto; gap:5px; border-color:var(--primary); color:var(--primary)">
                <i id="cloud-icon" class="ri-cloud-download-line"></i> <span id="cloud-text">Cargar Nube</span>
            </button>
        </div>
        <div class="calendar-wrapper card">
            <div class="cal-header">
                <button class="btn text" onclick="changeMonth(-1)"><i class="ri-arrow-left-s-line"></i></button>
                <span id="cal-month-year" style="font-weight:800; font-size:16px; text-transform:capitalize">Mes</span>
                <button class="btn text" onclick="changeMonth(1)"><i class="ri-arrow-right-s-line"></i></button>
            </div>
            <div class="cal-grid">
                <div class="cal-day-label">D</div><div class="cal-day-label">L</div><div class="cal-day-label">M</div><div class="cal-day-label">M</div><div class="cal-day-label">J</div><div class="cal-day-label">V</div><div class="cal-day-label">S</div>
                <div id="cal-days-container" style="display:contents"></div>
            </div>
        </div>
        <h3 id="history-date-title" style="margin:20px 0 10px; color:var(--primary)">Actividad</h3>
        <div id="history-list"></div>
    </div>

    <div id="editor" class="screen" style="padding-bottom:100px; padding-top:20px">
        <h2 style="text-align:center; margin-bottom:20px;">Editor Rutinas</h2>
        <div id="editor-list"></div>
        
        <div class="bottom-action-bar">
            <button class="btn icon" style="width:50px; height:50px; background:rgba(255,255,255,0.1);" onclick="go('home')"><i class="ri-home-5-line" style="font-size:24px;"></i></button>
            <button class="btn icon action-green" style="width:60px; height:60px;" onclick="createNewRoutine()"><i class="ri-add-line"></i></button>
        </div>
    </div>

    <div id="editor-detail" class="screen" style="padding-bottom:100px; padding-top:20px">
        <div style="text-align:center; margin-bottom:10px;">
            <input type="text" id="routine-title-input" placeholder="Nombre Rutina" style="background:transparent; border:none; font-size:20px; font-weight:700; text-align:center; color:white; width:80%">
        </div>
        <div style="text-align:center; padding-bottom:10px;">
            <input type="text" id="routine-tag-input" placeholder="Etiqueta (ej: Lun/Vie)" style="background:rgba(255,255,255,0.05); border:none; border-radius:20px; font-size:12px; padding:6px 12px; width:50%; color:#60a5fa; text-align:center">
        </div>

        <div class="divider-title">üî• Calentamiento</div>
        <div id="editor-warmup-list"></div>
        <button class="btn small" onclick="addWarmupInput()" style="margin:10px 0; width:auto; border-style:dashed; opacity:0.7">+ Agregar Item Calentamiento</button>

        <div class="divider-title">üí™ Ejercicios</div>
        <div id="routine-exercises-list"></div>
        <button class="btn small" onclick="addExerciseInput()" style="margin:20px auto; display:block; width:auto; border-color:var(--primary); color:var(--primary)">+ Agregar Ejercicio</button>
        
        <button class="btn danger" id="delete-routine-btn" style="margin-top:40px">Eliminar Rutina</button>

        <div class="bottom-action-bar">
            <button class="btn icon" style="width:50px; height:50px; background:rgba(255,255,255,0.1);" onclick="go('editor')"><i class="ri-arrow-left-line" style="font-size:24px;"></i></button>
            <button class="btn icon action-green" style="width:60px; height:60px;" onclick="saveRoutineDetail()"><i class="ri-save-line"></i></button>
        </div>
    </div>

    <nav id="navbar" class="nav">
        <button class="nav-item active" onclick="go('home')"><i class="ri-home-5-line"></i></button>
        <button class="nav-item" onclick="go('history')"><i class="ri-calendar-check-line"></i></button>
    </nav>
</div>

<script>
// 1. DATA (SIN PREDEFINIDOS)
let ROUTINES = JSON.parse(localStorage.getItem('pro_tracker_routines')) || {};
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let currentDate = new Date(), selectedDateISO = getLocalISO(), currentRoutineId = null;

// 2. HELPERS
function getLocalISO(d=new Date()){ const z=d.getTimezoneOffset()*60*1000; return new Date(d-z).toISOString().split('T')[0]; }
function go(id){
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
    const nav = document.getElementById('navbar');
    if(id==='home'){document.querySelectorAll('.nav-item')[0].classList.add('active'); renderRoutinesHome();}
    if(id==='history'){document.querySelectorAll('.nav-item')[1].classList.add('active'); renderCalendar(); renderHistoryList(selectedDateISO);}
    if(id==='editor') renderEditorList();
    if(['training','editor','editor-detail'].includes(id)) nav.classList.add('hidden'); else nav.classList.remove('hidden');
}

// 3. S√öPER SYNC
function updateSyncUI(s){
    const el=document.getElementById('sync-status'), i=el.querySelector('i'), t=el.querySelector('span');
    if(s==='synced'){el.className='sync-badge';i.className='ri-cloud-check-line';i.classList.remove('sync-spin');t.innerText="Al d√≠a";}
    else if(s==='syncing'){el.className='sync-badge pending';i.className='ri-loader-4-line sync-spin';t.innerText="Sync...";}
    else if(s==='pending'){el.className='sync-badge pending';i.className='ri-cloud-off-line';i.classList.remove('sync-spin');t.innerText="Guardar";}
    else{el.className='sync-badge error';i.className='ri-error-warning-line';i.classList.remove('sync-spin');t.innerText="Error";}
}

async function forceSync() {
    if(API_URL.includes("GOOGLE")) { alert("Configura la URL"); return; } if(!navigator.onLine) { alert("Offline"); return; }
    updateSyncUI('syncing');
    try {
        const h=JSON.parse(localStorage.getItem('pro_tracker_db'))||[], w=JSON.parse(localStorage.getItem('weight_log'))||[];
        const uH=h.filter(x=>!x.synced), uW=w.filter(x=>!x.synced);
        if(uH.length>0||uW.length>0){ 
            for(let s of uH){await fetch(API_URL,{method:'POST',mode:'no-cors',body:JSON.stringify({action:'save_workout',...s})});s.synced=true;}
            localStorage.setItem('pro_tracker_db',JSON.stringify(h));
            for(let i of uW){await fetch(API_URL,{method:'POST',mode:'no-cors',body:JSON.stringify({action:'save_weight',date:i.date,weight:i.weight})});i.synced=true;}
            localStorage.setItem('weight_log',JSON.stringify(w));
        }
        
        const localR = JSON.parse(localStorage.getItem('pro_tracker_routines'));
        if(localR) await fetch(API_URL,{method:'POST',mode:'no-cors',body:JSON.stringify({action:'save_routines',payload:localR})});

        const res=await fetch(API_URL); const cloud=await res.json();
        
        const mapH=new Map(); cloud.history.forEach(x=>mapH.set(x.id,x)); h.forEach(x=>{if(!mapH.has(x.id))mapH.set(x.id,x)}); 
        localStorage.setItem('pro_tracker_db',JSON.stringify(Array.from(mapH.values())));
        
        if(cloud.weights?.length){
            localStorage.setItem('weight_log',JSON.stringify(cloud.weights)); 
            const l=cloud.weights[cloud.weights.length-1]; 
            localStorage.setItem('user_weight_current',l.weight); 
            localStorage.setItem('user_weight_date',new Date(l.date).toLocaleDateString('es-ES',{day:'numeric',month:'short'}));
        }
        
        if(cloud.routines) {
            localStorage.setItem('pro_tracker_routines', JSON.stringify(cloud.routines));
            ROUTINES = cloud.routines;
            renderRoutinesHome();
        }

        updateSyncUI('synced'); confetti({particleCount:50,spread:60,origin:{y:0.1},colors:['#10b981']}); 
        renderStats(); renderCalendar(); if(selectedDateISO) renderHistoryList(selectedDateISO);
    } catch(e){ console.error(e); updateSyncUI('error'); }
}
async function downloadData(){await forceSync();alert("Datos actualizados");}

// 4. EDITOR RUTINAS
function renderRoutinesHome() {
    const c = document.getElementById('routines-list'); c.innerHTML = '';
    const keys = Object.keys(ROUTINES);
    if(keys.length === 0) { c.innerHTML = '<div style="text-align:center;padding:20px;color:#64748b">No hay rutinas.<br>Sincroniza o crea una nueva.</div>'; return; }
    keys.forEach(id => {
        const r = ROUTINES[id]; const tag = r.tag ? `<span class="tag blue">${r.tag}</span>` : '';
        c.innerHTML += `<div class="card" onclick="startWorkout('${id}')"><div class="flex-between">${tag}<i class="ri-arrow-right-s-line" style="color:var(--text-muted)"></i></div><h2 style="margin-top:8px">${r.title}</h2></div>`;
    });
}
function renderEditorList() {
    const c = document.getElementById('editor-list'); c.innerHTML = '';
    Object.keys(ROUTINES).forEach(id => {
        c.innerHTML += `<div class="card flex-between" onclick="editRoutine('${id}')"><strong>${ROUTINES[id].title}</strong><i class="ri-edit-2-line" style="color:var(--text-muted)"></i></div>`;
    });
}

function createNewRoutine() { currentRoutineId = 'custom_' + Date.now(); ROUTINES[currentRoutineId] = { title: "", tag:"", warmup:[], exercises: [] }; editRoutine(currentRoutineId); }

function editRoutine(id) {
    currentRoutineId = id; const r = ROUTINES[id];
    document.getElementById('routine-title-input').value = r.title;
    document.getElementById('routine-tag-input').value = r.tag || "";
    
    const wList = document.getElementById('editor-warmup-list'); wList.innerHTML = '';
    const warmups = r.warmup || []; // Vac√≠o por defecto
    warmups.forEach(w => addWarmupInput(w));

    const list = document.getElementById('routine-exercises-list'); list.innerHTML = '';
    r.exercises.forEach(ex => addExerciseInput(ex));
    
    const delBtn = document.getElementById('delete-routine-btn');
    delBtn.onclick = () => deleteRoutine(id);
    // ‚¨áÔ∏è MODIFICADO: Ahora el bot√≥n de eliminar SIEMPRE es visible
    delBtn.style.display = 'block'; 
    
    go('editor-detail');
}

function addWarmupInput(val = "") {
    const div = document.createElement('div'); div.className = 'flex-between'; div.style.marginBottom = '8px';
    div.innerHTML = `
        <input type="text" class="warmup-val" value="${val}" placeholder="Actividad (ej: 5 min cinta)" style="text-align:left; background:rgba(255,255,255,0.03); border:none">
        <button class="btn icon small" onclick="this.parentElement.remove()" style="color:#64748b; margin-left:8px"><i class="ri-close-line"></i></button>
    `;
    document.getElementById('editor-warmup-list').appendChild(div);
}

function addExerciseInput(ex = null) {
    const div = document.createElement('div'); div.className = 'card editor-item-card';
    div.innerHTML = `
        <div class="editor-input-group"><input type="text" placeholder="Nombre Ejercicio" class="ex-name" value="${ex?.name||''}" style="text-align:left"><select class="ex-type"><option value="weighted" ${ex?.type==='weighted'?'selected':''}>Con Peso</option><option value="body" ${ex?.type==='body'?'selected':''}>Corporal</option><option value="time" ${ex?.type==='time'?'selected':''}>Tiempo</option></select></div>
        <div class="flex-between" style="margin-bottom:8px"><input type="text" placeholder="Nota (ej: Codos 45¬∞)" class="ex-note" value="${ex?.note||''}" style="text-align:left; width:80%"><button class="btn icon small" onclick="this.closest('.editor-item-card').remove()" style="color:var(--danger)"><i class="ri-delete-bin-line"></i></button></div>
        <div><input type="text" placeholder="Pegar Link YouTube..." class="ex-url" value="${ex?.url||''}" style="text-align:left; font-size:12px; opacity:0.7; background:rgba(0,0,0,0.3)"></div>`;
    document.getElementById('routine-exercises-list').appendChild(div);
}

function saveRoutineDetail() {
    const title = document.getElementById('routine-title-input').value.trim(); if(!title) return alert("Ponle nombre");
    const tag = document.getElementById('routine-tag-input').value.trim();
    
    const warmup = [];
    document.querySelectorAll('.warmup-val').forEach(inp => {
        if(inp.value.trim()) warmup.push(inp.value.trim());
    });

    const exercises = [];
    document.querySelectorAll('.editor-item-card').forEach(card => {
        const name = card.querySelector('.ex-name').value.trim();
        if(name) {
            exercises.push({ 
                name, 
                type: card.querySelector('.ex-type').value, 
                note: card.querySelector('.ex-note').value.trim(),
                url: card.querySelector('.ex-url').value.trim()
            });
        }
    });
    if(!exercises.length) return alert("Agrega ejercicios");

    ROUTINES[currentRoutineId] = { title, tag, warmup, exercises }; 
    localStorage.setItem('pro_tracker_routines', JSON.stringify(ROUTINES));
    go('editor');
    updateSyncUI('pending');
}

function deleteRoutine(id) { 
    delete ROUTINES[id]; localStorage.setItem('pro_tracker_routines', JSON.stringify(ROUTINES)); go('editor'); updateSyncUI('pending'); 
}

// 5. TRAINING ENGINE
function startWorkout(id) {
    if(audioCtx.state === 'suspended') audioCtx.resume();
    const t = ROUTINES[id]; currentRoutineId = id;
    document.getElementById('active-title').innerText = t.title;
    
    const currentWarmup = t.warmup || []; // Vac√≠o por defecto
    const wContainer = document.getElementById('warmup-items');
    if (currentWarmup.length === 0) {
        wContainer.innerHTML = '<div style="text-align:center; padding:10px; color:#64748b; font-size:12px">Sin calentamiento espec√≠fico</div>';
    } else {
        wContainer.innerHTML = currentWarmup.map(w => `<label class="warmup-item"><span>${w}</span><input type="checkbox" class="native-check"></label>`).join('');
    }
    
    const c = document.getElementById('workout-container'); c.innerHTML = '';
    t.exercises.forEach(ex => {
        const ytBtn = ex.url ? `<a href="${ex.url}" target="_blank" class="btn yt"><i class="ri-youtube-fill"></i> Ver Video</a>` : '';
        
        let head = '', btnTxt = ex.type==='time' ? '+ Tiempo' : '+ Set';
        if(ex.type==='weighted') head = `<div class="sets-header grid-weighted"><span>#</span><span>KG</span><span>REPS</span><span>OK</span></div>`;
        else head = `<div class="sets-header grid-simple"><span>#</span><span>${ex.type==='time'?'TIEMPO':'REPS'}</span><span>OK</span></div>`;
        
        c.innerHTML += `<div class="card ex-card" data-n="${ex.name}" data-t="${ex.type}"><div class="flex-between"><div><strong style="font-size:16px; display:flex; align-items:center">${ex.name} ${ytBtn}</strong><div style="font-size:11px;color:var(--warning);margin-top:4px">${ex.note}</div></div><button class="btn small" onclick="addSet(this, '${ex.type}')">${btnTxt}</button></div><div style="margin-top:15px">${head}<div class="sets"></div></div></div>`;
    });
    go('training');
}
function addSet(btn, type) {
    const w=btn.parentElement.nextElementSibling.querySelector('.sets'), n=w.children.length+1, d=document.createElement('div');
    let inp=type==='weighted'?`<input type="number" placeholder="kg" class="val-kg"><input type="number" placeholder="reps" class="val-reps">`:`<input type="${type==='time'?'text':'number'}" placeholder="${type==='time'?'30s':'Reps'}" class="val-reps">`;
    d.className=`set-row ${type} ${type==='weighted'?'grid-weighted':'grid-simple'}`; 
    d.innerHTML=`<span class="set-num">${n}</span>${inp}<div class="check-btn" onclick="toggleCheck(this)"><i class="ri-check-line"></i></div>`;
    w.appendChild(d);
}
function toggleCheck(el) {
    el.classList.toggle('checked'); const i=el.parentElement.querySelectorAll('input');
    if(el.classList.contains('checked')){i.forEach(x=>x.style.opacity=0.5);startTimer(90);}else i.forEach(x=>x.style.opacity=1);
}
function finishWorkout() {
    stopTimer();
    const title = document.getElementById('active-title').innerText, isoDate = getLocalISO(), prettyDate = new Date().toLocaleDateString('es-ES', {weekday:'short', day:'numeric'});
    const warmChecks = Array.from(document.querySelectorAll('.native-check')).map(c => c.checked ? '‚òë' : '‚òê').join(' ');
    const warmText = warmChecks.includes('‚òë') ? "Calentamiento Realizado" : "Sin Calentar";
    const session = { id:Date.now(), title, isoDate, date:prettyDate, warmup: warmText, data:[], synced:false };
    document.querySelectorAll('.ex-card').forEach(card => {
        let sets = [];
        card.querySelectorAll('.set-row').forEach(row => {
            if(row.querySelector('.check-btn').classList.contains('checked')) sets.push({ kg: row.querySelector('.val-kg')?.value || '-', reps: row.querySelector('.val-reps')?.value || '-' });
        });
        if(sets.length) session.data.push({ name: card.dataset.n, type: card.dataset.t, sets });
    });
    if(!session.data.length) return alert("Vacio");
    const h = JSON.parse(localStorage.getItem('pro_tracker_db')) || []; h.push(session); localStorage.setItem('pro_tracker_db', JSON.stringify(h));
    confetti(); renderStats(); go('home'); forceSync();
}

// 6. COMMON
function saveBodyWeight() {
    const v = parseFloat(document.getElementById('input-bodyweight').value); if(!v) return;
    localStorage.setItem('user_weight_current', v); localStorage.setItem('user_weight_date', new Date().toLocaleDateString('es-ES',{day:'numeric',month:'short'}));
    const l = JSON.parse(localStorage.getItem('weight_log')) || []; l.push({ date: getLocalISO(), weight: v, synced: false }); localStorage.setItem('weight_log', JSON.stringify(l));
    document.getElementById('input-bodyweight').value = ''; renderStats(); forceSync();
}
let timerI=null,secL=0; function startTimer(s){stopTimer();secL=s;document.getElementById('rest-timer').classList.remove('hidden');ut();timerI=setInterval(()=>{secL--;ut();if(secL<=0){stopTimer();playBeep();}},1000);} function stopTimer(){clearInterval(timerI);document.getElementById('rest-timer').classList.add('hidden');} function addTime(s){secL+=s;ut();} function ut(){const m=Math.floor(secL/60).toString().padStart(2,'0'),s=(secL%60).toString().padStart(2,'0');document.getElementById('timer-countdown').innerText=`${m}:${s}`;} function playBeep(){const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.frequency.value=800;g.gain.value=0.1;o.start();setTimeout(()=>o.stop(),200);}
let chart=null; function renderStats(){const h=JSON.parse(localStorage.getItem('pro_tracker_db'))||[];document.getElementById('total-sessions').innerText=h.length;const w=localStorage.getItem('user_weight_current');if(w){document.getElementById('current-weight-display').innerText=w+' kg';document.getElementById('last-weight-date').innerText=localStorage.getItem('user_weight_date');}const p=h.some(x=>!x.synced)||(JSON.parse(localStorage.getItem('weight_log'))||[]).some(x=>!x.synced);updateSyncUI(p?'pending':'synced');const ctx=document.getElementById('weightChart');if(ctx){const l=JSON.parse(localStorage.getItem('weight_log'))||[],d=l.slice(-10);if(chart)chart.destroy();chart=new Chart(ctx,{type:'line',data:{labels:d.map(x=>x.date.slice(5)),datasets:[{data:d.map(x=>x.weight),borderColor:'#10b981',backgroundColor:'rgba(16,185,129,0.1)',borderWidth:3,tension:0.4,fill:true,pointRadius:4,pointBackgroundColor:'#064e3b'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{display:false},y:{display:false}}}});}}
function renderCalendar(){const y=currentDate.getFullYear(),m=currentDate.getMonth();document.getElementById('cal-month-year').innerText=`${["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"][m]} ${y}`;const c=document.getElementById('cal-days-container');c.innerHTML='';const h=JSON.parse(localStorage.getItem('pro_tracker_db'))||[], dates=h.map(x=>x.isoDate);const fd=new Date(y,m,1).getDay(),dim=new Date(y,m+1,0).getDate(),today=getLocalISO();for(let i=0;i<fd;i++)c.innerHTML+=`<div class="cal-day" style="opacity:0"></div>`;for(let d=1;d<=dim;d++){const iso=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;let cls=iso===today?'today':iso===selectedDateISO?'selected':'';if(dates.includes(iso))cls+=' has-workout';c.innerHTML+=`<div class="cal-day ${cls}" onclick="selectDate('${iso}')">${d}</div>`;}}
function changeMonth(d){currentDate.setMonth(currentDate.getMonth()+d);renderCalendar();} function selectDate(iso){selectedDateISO=iso;renderCalendar();renderHistoryList(iso);}
async function deleteItem(id) { let h=JSON.parse(localStorage.getItem('pro_tracker_db'))||[]; h=h.filter(x=>x.id!==id); localStorage.setItem('pro_tracker_db',JSON.stringify(h)); renderCalendar(); renderHistoryList(selectedDateISO); renderStats(); if(navigator.onLine && !API_URL.includes("GOOGLE")) { try { await fetch(API_URL,{method:'POST',mode:'no-cors',body:JSON.stringify({action:'delete_workout',id:id})}); } catch(e){} } }
function renderHistoryList(iso){const h=JSON.parse(localStorage.getItem('pro_tracker_db'))||[],list=document.getElementById('history-list');list.innerHTML='';const [y,m,d]=iso.split('-');document.getElementById('history-date-title').innerText=`Actividad ${d}/${m}`;const items=h.filter(x=>x.isoDate===iso).reverse();if(!items.length){list.innerHTML='<div style="text-align:center;color:#64748b;padding:20px">Nada este d√≠a</div>';return;}items.forEach(s=>{let details='';if(s.warmup)details+=`<div style="font-size:11px;color:#fbbf24;margin-bottom:8px">üî• ${s.warmup}</div>`;s.data.forEach(ex=>{details+=`<div style="margin-top:10px"><div class="hist-ex-title">${ex.name}</div>`;ex.sets.forEach((set,i)=>{let inf=ex.type==='weighted'?`${set.kg}kg √ó ${set.reps}`:ex.type==='time'?`${set.reps}`:`${set.reps} reps`;details+=`<div class="hist-set-row"><span class="hist-set-num">Set ${i+1}</span><span style="color:white;font-weight:600">${inf}</span></div>`;});details+=`</div>`;});const icon=s.synced?'<i class="ri-cloud-check-line" style="color:#34d399"></i>':'<i class="ri-upload-cloud-line" style="color:#fbbf24"></i>';list.innerHTML+=`<div class="card"><div class="flex-between" style="margin-bottom:5px;border-bottom:1px solid #334155;padding-bottom:8px"><strong>${s.title}</strong><div style="display:flex;gap:10px;align-items:center">${icon} <button onclick="deleteItem(${s.id})" style="background:none;border:none;color:#f87171;padding:0"><i class="ri-delete-bin-line" style="font-size:18px"></i></button></div></div>${details}</div>`;});}
function cancelWorkout(){go('home');} function resetApp(){localStorage.clear();location.reload();}

renderStats(); renderRoutinesHome();
</script>
</body>
</html>