<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Pro Tracker Elite</title>

<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">

<style>
/* --- 1. VARIABLES & RESET --- */
:root {
    --bg-body: #000000;
    --bg-app: #0f172a;
    --surface: #1e293b;
    --surface-hover: #334155; 
    --primary: #6366f1;
    --text-main: #f8fafc;
    --text-muted: #94a3b8;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --radius: 16px;
    --app-width: 460px;
    --safe-area-bottom: env(safe-area-inset-bottom);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body { 
    margin: 0; background-color: var(--bg-body); color: var(--text-main); 
    font-family: 'Inter', sans-serif; font-size: 14px;
    display: flex; justify-content: center; min-height: 100vh;
}

.app-container {
    width: 100%; max-width: var(--app-width); background-color: var(--bg-app);
    min-height: 100vh; position: relative; 
    box-shadow: 0 0 50px rgba(255,255,255,0.05);
    overflow-x: hidden; 
    padding-bottom: calc(100px + var(--safe-area-bottom));
    padding-top: env(safe-area-inset-top);
}

/* --- 2. COMPONENTES UI --- */
h1 { font-size: 22px; font-weight: 800; margin: 0; letter-spacing: -0.5px; }
h2 { font-size: 18px; font-weight: 700; margin: 0; }
small { color: var(--text-muted); font-size: 12px; }

/* Botones */
.btn {
    background: var(--primary); color: white; border: none; padding: 14px; border-radius: var(--radius);
    font-weight: 700; font-size: 15px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px;
    width: 100%; transition: transform 0.1s; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
}
.btn:active { transform: scale(0.97); }
.btn.icon { width: 40px; height: 40px; padding: 0; border-radius: 50%; background: rgba(255,255,255,0.05); box-shadow: none; color: white; }
.btn.small { padding: 8px 12px; font-size: 12px; width: auto; background: transparent; border: 1px dashed var(--surface-hover); color: var(--primary); box-shadow: none; }
.btn.text { background: none; box-shadow: none; padding: 8px; width: auto; color: var(--text-muted); font-size: 14px; }

/* Tarjetas */
.card { background: var(--surface); border-radius: var(--radius); padding: 16px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.03); }

/* --- 3. INPUTS & CHECKBOXES (SOLUCIONADO) --- */

/* Input de Texto/Numero (Entrenamientos) */
input[type="number"], input[type="text"] { 
    background: #020617; border: 1px solid var(--surface-hover); color: white; 
    padding: 10px; border-radius: 8px; text-align: center; width: 100%; 
    font-size: 16px; font-weight: 600; outline: none; font-family: inherit;
}
input:focus { border-color: var(--primary); }

/* Checkbox de CALENTAMIENTO (Nativo mejorado) */
.warmup-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer;
}
.warmup-item:last-child { border-bottom: none; }
.warmup-item span { color: #cbd5e1; font-size: 14px; }

/* Reset espec√≠fico para checkbox nativo */
input[type="checkbox"].native-check {
    appearance: auto; width: 24px; height: 24px; margin: 0; 
    accent-color: var(--success); cursor: pointer;
    background: transparent; border: none; padding: 0; /* Reset del input global */
}

/* Checkbox de SERIES (Bot√≥n grande personalizado) */
.check-btn { 
    width: 100%; height: 42px; border-radius: 8px; background: #020617; 
    border: 1px solid var(--surface-hover); display: flex; align-items: center; 
    justify-content: center; cursor: pointer; transition: all 0.2s; 
}
.check-btn.checked { background: var(--success); border-color: var(--success); }
.check-btn i { opacity: 0; transform: scale(0.5); transition: 0.2s; color: #022c22; font-weight: bold; font-size: 20px; }
.check-btn.checked i { opacity: 1; transform: scale(1); }

/* --- 4. GRILLAS DE ENTRENAMIENTO (ALINEACI√ìN) --- */
/* Header de la tabla */
.sets-header { 
    display: grid; gap: 8px; font-size: 10px; color: var(--text-muted); 
    text-align: center; margin-bottom: 6px; font-weight: 700; letter-spacing: 0.5px;
    padding: 0 2px; /* Ajuste fino */
}
/* Filas de la tabla */
.set-row { margin-bottom: 8px; align-items: center; display: grid; gap: 8px; }

/* Grid: # (30px) | Inputs (Flex) | Checkbox (42px) */
.grid-weighted { grid-template-columns: 30px 1fr 1fr 44px; }
.grid-simple { grid-template-columns: 30px 1fr 44px; }

.set-num { text-align: center; color: var(--text-muted); font-weight: 600; font-size: 12px; }

/* --- 5. EXTRAS --- */
.flex-between { display: flex; justify-content: space-between; align-items: center; }
.hidden { display: none !important; }
.tag { padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 800; text-transform: uppercase; }
.tag.blue { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
.tag.orange { background: rgba(249, 115, 22, 0.2); color: #fb923c; }

/* Sync Badge */
.sync-badge { background: rgba(16, 185, 129, 0.2); color: #34d399; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; display: flex; align-items: center; gap: 6px; cursor: pointer; border: 1px solid rgba(16, 185, 129, 0.3); }
.sync-badge.pending { background: rgba(245, 158, 11, 0.2); color: #fbbf24; border-color: rgba(245, 158, 11, 0.3); }
.sync-badge.error { background: rgba(239, 68, 68, 0.2); color: #f87171; border-color: rgba(239, 68, 68, 0.3); }
.sync-spin { animation: spin 1s linear infinite; } @keyframes spin { 100% { transform: rotate(360deg); } }

/* Animaciones */
.screen { display: none; padding: 20px; animation: fadeIn 0.3s; }
.screen.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* Timer Float */
.timer-float {
    position: fixed; bottom: calc(90px + var(--safe-area-bottom)); right: 20px; left: 20px;
    background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px);
    border: 1px solid rgba(99, 102, 241, 0.3);
    border-radius: 16px; padding: 12px 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 200;
}

/* Calendario */
.cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; margin-top: 10px; }
.cal-day-label { color: var(--text-muted); font-size: 10px; font-weight: bold; margin-bottom: 5px; }
.cal-day { aspect-ratio: 1/1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 10px; font-size: 13px; cursor: pointer; position: relative; border: 1px solid transparent; background: rgba(255,255,255,0.02); }
.cal-day.today { border-color: var(--primary); color: var(--primary); font-weight: bold; }
.cal-day.selected { background: var(--primary) !important; color: white !important; border-color: transparent; }
.cal-day.has-workout::after { content: ''; position: absolute; bottom: 4px; width: 4px; height: 4px; background-color: var(--success); border-radius: 50%; }
.cal-day.selected.has-workout::after { background-color: white; }

/* Historial Detallado */
.hist-ex-title { color: var(--primary); font-weight: 700; font-size: 14px; margin-bottom: 6px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 4px; }
.hist-set-row { display: flex; justify-content: space-between; font-size: 13px; color: #cbd5e1; margin-bottom: 4px; padding: 4px 8px; background: rgba(0,0,0,0.2); border-radius: 6px; }
.hist-set-num { color: var(--text-muted); font-size: 11px; margin-right: 8px; }

/* Nav */
.nav {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
    width: 90%; max-width: 440px;
    background: rgba(30, 41, 59, 0.9); backdrop-filter: blur(12px);
    border-radius: 24px; padding: 12px 40px;
    display: flex; justify-content: space-between; align-items: center;
    border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.6); 
    z-index: 1000;
}
.nav-item { background: none; border: none; color: var(--text-muted); font-size: 10px; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
.nav-item.active { color: var(--primary); }
.nav-item i { font-size: 22px; }
</style>
</head>
<body>

<script>
    // ‚ö†Ô∏è REEMPLAZAR CON TU URL DE GOOGLE SCRIPT ‚ö†Ô∏è
    const API_URL = "https://script.google.com/macros/s/AKfycbxEc1eyXOkWvTCq71RrBdD2VgRLS6RUUYBnvcc75i_nPJiFnod6gZiNFVgy32ZrzYZhvw/exec"; 
</script>

<div id="rest-timer" class="timer-float hidden">
    <div class="flex-between">
        <div><small>Descanso</small><div id="timer-countdown" style="font-weight:800;font-size:24px;color:white">01:30</div></div>
        <div class="flex-between" style="gap:10px">
            <button class="btn small" style="width:40px;height:40px;border-radius:50%;border:1px solid rgba(255,255,255,0.2);color:white" onclick="addTime(30)">+30</button>
            <button class="btn small" style="width:40px;height:40px;border-radius:50%;border-color:#f87171;color:#f87171" onclick="stopTimer()"><i class="ri-stop-fill"></i></button>
        </div>
    </div>
</div>

<div class="app-container">

    <div id="home" class="screen active">
        <div class="flex-between" style="margin-bottom:20px">
            <div><small>Bienvenido</small><h1>Hola, Atleta ‚ö°</h1></div>
            <div id="sync-status" class="sync-badge" onclick="forceSync()">
                <i class="ri-cloud-line"></i> <span>Sync</span>
            </div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:15px">
            <div class="card" style="margin:0; padding:12px; text-align:center">
                <div id="current-weight-display" style="color:var(--success);font-weight:800;font-size:16px">--</div>
                <small>Peso</small>
            </div>
            <div class="card" style="margin:0; padding:12px; text-align:center">
                <div style="color:white;font-weight:800;font-size:16px">78 kg</div>
                <small>Meta</small>
            </div>
            <div class="card" style="margin:0; padding:12px; text-align:center">
                <div id="total-sessions" style="color:var(--primary);font-weight:800;font-size:16px">0</div>
                <small>Sesiones</small>
            </div>
        </div>

        <div class="card" style="border:1px solid rgba(16,185,129,0.2); background: #0b1221">
            <div class="flex-between" style="margin-bottom:15px">
                <strong style="color:#6ee7b7"><i class="ri-line-chart-line"></i> Progreso Peso</strong>
                <small id="last-weight-date" style="color:#a7f3d0">--</small>
            </div>
            <div style="height:120px; width:100%"><canvas id="weightChart"></canvas></div>
            <div class="flex-between" style="gap:10px; border-top:1px solid rgba(255,255,255,0.05); padding-top:15px; margin-top:10px">
                <input type="number" id="input-bodyweight" placeholder="Nuevo peso (kg)" style="text-align:left">
                <button class="btn small" style="background:#10b981; color:black; border:none; width:auto" onclick="saveBodyWeight()">Guardar</button>
            </div>
        </div>

        <h3 style="margin:25px 0 10px; color:var(--text-muted); font-size:12px; letter-spacing:1px">RUTINAS</h3>
        
        <div class="card" onclick="startWorkout('fuerzaA')">
            <div class="flex-between"><span class="tag blue">Lun / Vie</span><i class="ri-arrow-right-s-line" style="color:var(--text-muted)"></i></div>
            <h2 style="margin-top:8px">üèãÔ∏è Fuerza A (Full Body)</h2>
        </div>
        <div class="card" onclick="startWorkout('cardio')">
            <div class="flex-between"><span class="tag orange">Mar / Jue</span><i class="ri-arrow-right-s-line" style="color:var(--text-muted)"></i></div>
            <h2 style="margin-top:8px">üö¥ Bici + Movilidad</h2>
        </div>
        <div class="card" onclick="startWorkout('fuerzaB')">
            <div class="flex-between"><span class="tag blue">Mi√©rcoles</span><i class="ri-arrow-right-s-line" style="color:var(--text-muted)"></i></div>
            <h2 style="margin-top:8px">üî• Fuerza B (Accesorios)</h2>
        </div>
        
        <button class="btn text" onclick="resetApp()" style="margin: 30px auto; display:block; font-size:12px; opacity:0.5">Resetear App</button>
    </div>

    <div id="training" class="screen" style="padding-bottom:40px">
        <div style="position:sticky; top:0; background:var(--bg-app); padding:15px 0; z-index:10; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(255,255,255,0.05)">
            <button class="btn icon" onclick="cancelWorkout()"><i class="ri-arrow-left-line"></i></button>
            <h2 id="active-title">Rutina</h2>
            <div style="width:40px"></div>
        </div>

        <div class="card" style="margin-top:20px; border-left:3px solid var(--warning); background:rgba(245,158,11,0.05)">
            <div class="flex-between" onclick="document.getElementById('warmup-items').classList.toggle('hidden')" style="cursor:pointer">
                <strong>üî• Calentamiento</strong> <i class="ri-arrow-down-s-line"></i>
            </div>
            <div id="warmup-items" class="hidden" style="margin-top:10px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.1)"></div>
        </div>

        <div id="workout-container"></div>
        <button class="btn" style="margin-top:30px; background:white; color:black" onclick="finishWorkout()">Finalizar Entrenamiento</button>
    </div>

    <div id="history" class="screen">
        <div class="flex-between" style="margin-bottom:15px">
            <h2>Calendario</h2>
            <button class="btn small" onclick="downloadData()" style="width:auto; gap:5px; border-color:var(--primary); color:var(--primary)">
                <i id="cloud-icon" class="ri-cloud-download-line"></i> <span id="cloud-text">Cargar Nube</span>
            </button>
        </div>

        <div class="calendar-wrapper card">
            <div class="cal-header">
                <button class="btn text" onclick="changeMonth(-1)"><i class="ri-arrow-left-s-line"></i></button>
                <span id="cal-month-year" style="font-weight:800; font-size:16px; text-transform:capitalize">Mes</span>
                <button class="btn text" onclick="changeMonth(1)"><i class="ri-arrow-right-s-line"></i></button>
            </div>
            <div class="cal-grid">
                <div class="cal-day-label">D</div><div class="cal-day-label">L</div><div class="cal-day-label">M</div><div class="cal-day-label">M</div><div class="cal-day-label">J</div><div class="cal-day-label">V</div><div class="cal-day-label">S</div>
                <div id="cal-days-container" style="display:contents"></div>
            </div>
        </div>

        <h3 id="history-date-title" style="margin:20px 0 10px; color:var(--primary)">Actividad</h3>
        <div id="history-list"></div>
    </div>

    <nav id="navbar" class="nav">
        <button class="nav-item active" onclick="go('home')"><i class="ri-home-5-line"></i></button>
        <button class="nav-item" onclick="go('history')"><i class="ri-calendar-check-line"></i></button>
    </nav>
</div>

<script>
/* ---------------- L√ìGICA DE LA APP ---------------- */

// 1. BASE DE DATOS LOCAL
const DB = {
    templates: {
        fuerzaA: { title: "Fuerza A", exercises: [{name:"Sentadilla",type:"body",note:"Peso corporal"},{name:"Press Pecho",type:"weighted",note:"Codos 45¬∞"},{name:"Remo",type:"weighted",note:"Espalda recta"},{name:"Peso Muerto",type:"weighted",note:"Liviano"},{name:"Plancha",type:"time",note:"30-40 seg"}] },
        fuerzaB: { title: "Fuerza B", exercises: [{name:"Zancadas",type:"body",note:"10/pierna"},{name:"Hombros",type:"weighted",note:"Sentado"},{name:"B√≠ceps",type:"weighted",note:"Controlado"},{name:"Tr√≠ceps",type:"weighted",note:"Cerrado"}] },
        cardio: { title: "Cardio", exercises: [{name:"Bici",type:"time",note:"Ritmo constante"},{name:"Estiramientos",type:"time",note:"Pecho/Espalda"}] }
    },
    warmup: ["Movilidad Cuello", "C√≠rculos Hombros", "Gato-Vaca", "Sentadillas Aire", "5 min suave"]
};

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let currentDate = new Date();
let selectedDateISO = getLocalISO();

// 2. HELPERS
function getLocalISO(d = new Date()) {
    const z = d.getTimezoneOffset() * 60 * 1000;
    return new Date(d - z).toISOString().split('T')[0];
}

function go(id){
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
    
    const nav = document.getElementById('navbar');
    if(id === 'home') document.querySelectorAll('.nav-item')[0].classList.add('active');
    if(id === 'history') {
        document.querySelectorAll('.nav-item')[1].classList.add('active');
        renderCalendar();
        renderHistoryList(selectedDateISO);
    }
    
    if(id === 'training') nav.classList.add('hidden');
    else nav.classList.remove('hidden');
}

// 3. SINCRONIZACI√ìN BIDIRECCIONAL (S√öPER SYNC)
function updateSyncUI(status) {
    const el = document.getElementById('sync-status');
    const i = el.querySelector('i'), t = el.querySelector('span');
    if(status==='synced'){el.className='sync-badge'; i.className='ri-cloud-check-line'; iconSpin(false); t.innerText="Al d√≠a";}
    else if(status==='syncing'){el.className='sync-badge pending'; i.className='ri-loader-4-line'; iconSpin(true); t.innerText="Sync...";}
    else if(status==='pending'){el.className='sync-badge pending'; i.className='ri-cloud-off-line'; iconSpin(false); t.innerText="Sync";}
    else {el.className='sync-badge error'; i.className='ri-error-warning-line'; iconSpin(false); t.innerText="Error";}
}
function iconSpin(spin){ 
    const i = document.querySelector('#sync-status i'); 
    spin ? i.classList.add('sync-spin') : i.classList.remove('sync-spin'); 
}

async function forceSync() {
    if(API_URL.includes("GOOGLE")) { alert("Configura la URL de Google Script"); return; }
    if(!navigator.onLine) { alert("Sin internet"); return; }
    
    updateSyncUI('syncing');
    
    try {
        // A. SUBIR LO PENDIENTE
        const h = JSON.parse(localStorage.getItem('pro_tracker_db')) || [];
        const w = JSON.parse(localStorage.getItem('weight_log')) || [];
        const uH = h.filter(x => !x.synced);
        const uW = w.filter(x => !x.synced);
        
        if(uH.length > 0 || uW.length > 0) {
            for(let s of uH) {
                await fetch(API_URL, { method:'POST', mode:'no-cors', body:JSON.stringify({action:'save_workout', ...s}) });
                s.synced = true;
            }
            localStorage.setItem('pro_tracker_db', JSON.stringify(h));
            
            for(let i of uW) {
                await fetch(API_URL, { method:'POST', mode:'no-cors', body:JSON.stringify({action:'save_weight', date:i.date, weight:i.weight}) });
                i.synced = true;
            }
            localStorage.setItem('weight_log', JSON.stringify(w));
        }

        // B. BAJAR Y RESTAURAR (Por si es un reset)
        const res = await fetch(API_URL);
        const cloud = await res.json();
        
        // Merge History
        const mapH = new Map();
        cloud.history.forEach(x => mapH.set(x.id, x)); // Prioridad Nube
        h.forEach(x => { if(!mapH.has(x.id)) mapH.set(x.id, x); }); // Conservar locales no subidos
        localStorage.setItem('pro_tracker_db', JSON.stringify(Array.from(mapH.values())));

        // Merge Weight
        if(cloud.weights && cloud.weights.length > 0) {
            localStorage.setItem('weight_log', JSON.stringify(cloud.weights));
            const last = cloud.weights[cloud.weights.length -1];
            localStorage.setItem('user_weight_current', last.weight);
            localStorage.setItem('user_weight_date', new Date(last.date).toLocaleDateString('es-ES',{day:'numeric',month:'short'}));
        }

        updateSyncUI('synced');
        confetti({ particleCount: 50, spread: 60, origin: { y: 0.1 }, colors:['#10b981'] });
        renderStats(); renderCalendar();
        if(selectedDateISO) renderHistoryList(selectedDateISO);

    } catch(e) { console.error(e); updateSyncUI('error'); }
}

// 4. ELIMINAR ITEM
async function deleteItem(id) {
    if(!confirm("¬øBorrar? Se eliminar√° de la nube.")) return;
    let h = JSON.parse(localStorage.getItem('pro_tracker_db')) || [];
    h = h.filter(x => x.id !== id);
    localStorage.setItem('pro_tracker_db', JSON.stringify(h));
    renderCalendar(); renderHistoryList(selectedDateISO); renderStats();
    if(navigator.onLine && !API_URL.includes("GOOGLE")) {
        try { await fetch(API_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({action:'delete_workout', id: id})}); } catch(e){}
    }
}

async function downloadData() {
    await forceSync();
    alert("Datos actualizados desde la nube.");
}

// 5. CHART & STATS
let chart = null;
function renderStats() {
    const h = JSON.parse(localStorage.getItem('pro_tracker_db')) || [];
    document.getElementById('total-sessions').innerText = h.length;
    
    const w = localStorage.getItem('user_weight_current');
    if(w) {
        document.getElementById('current-weight-display').innerText = w + ' kg';
        document.getElementById('last-weight-date').innerText = localStorage.getItem('user_weight_date');
    }
    
    const pending = h.some(x=>!x.synced) || (JSON.parse(localStorage.getItem('weight_log'))||[]).some(x=>!x.synced);
    updateSyncUI(pending ? 'pending' : 'synced');

    // Chart
    const ctx = document.getElementById('weightChart');
    if(ctx) {
        const log = JSON.parse(localStorage.getItem('weight_log')) || [];
        const data = log.slice(-10);
        if(chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(d => d.date.slice(5)), 
                datasets: [{
                    data: data.map(d => d.weight),
                    borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', borderWidth: 3, tension: 0.4, fill: true, pointRadius: 4, pointBackgroundColor:'#064e3b'
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
        });
    }
}

// 6. TRAINING ENGINE
function startWorkout(type) {
    if(audioCtx.state === 'suspended') audioCtx.resume();
    const t = DB.templates[type];
    document.getElementById('active-title').innerText = t.title;
    
    // HTML GENERADO CON CLASES CORRECTAS PARA CHECKBOX
    document.getElementById('warmup-items').innerHTML = DB.warmup.map(w => 
        `<label class="warmup-item">
            <span>${w}</span>
            <input type="checkbox" class="native-check">
        </label>`
    ).join('');

    const c = document.getElementById('workout-container'); c.innerHTML = '';
    t.exercises.forEach(ex => {
        let head = '';
        if(ex.type==='weighted') head = `<div class="sets-header grid-weighted"><span>#</span><span>KG</span><span>REPS</span><span>OK</span></div>`;
        else head = `<div class="sets-header grid-simple"><span>#</span><span>${ex.type==='time'?'TIEMPO':'REPS'}</span><span>OK</span></div>`;
        
        let btnTxt = ex.type==='time' ? '+ Tiempo' : '+ Set';

        c.innerHTML += `
        <div class="card ex-card" data-n="${ex.name}" data-t="${ex.type}">
            <div class="flex-between">
                <div><strong style="font-size:16px">${ex.name}</strong><div style="font-size:11px;color:var(--warning);margin-top:4px">${ex.note}</div></div>
                <button class="btn small" onclick="addSet(this, '${ex.type}')">${btnTxt}</button>
            </div>
            <div style="margin-top:15px">${head}<div class="sets"></div></div>
        </div>`;
    });
    go('training');
}

function addSet(btn, type) {
    const sets = btn.parentElement.nextElementSibling.querySelector('.sets');
    const n = sets.children.length + 1;
    const div = document.createElement('div');
    
    let inputs = '';
    let gridClass = '';
    
    if(type === 'weighted') {
        gridClass = 'set-row weighted grid-weighted';
        inputs = `<input type="number" placeholder="kg" class="val-kg"><input type="number" placeholder="reps" class="val-reps">`;
    } else {
        gridClass = 'set-row body grid-simple';
        inputs = `<input type="${type==='time'?'text':'number'}" placeholder="${type==='time'?'30s':'Reps'}" class="val-reps">`;
    }
    
    div.className = gridClass;
    div.innerHTML = `<span class="set-num">${n}</span>${inputs}<div class="check-btn" onclick="toggleCheck(this)"><i class="ri-check-line"></i></div>`;
    sets.appendChild(div);
}

function toggleCheck(el) {
    el.classList.toggle('checked');
    const inputs = el.parentElement.querySelectorAll('input');
    if(el.classList.contains('checked')) {
        inputs.forEach(i => i.style.opacity = 0.5);
        startTimer(90);
    } else {
        inputs.forEach(i => i.style.opacity = 1);
    }
}

// 7. SAVE & PESO
function finishWorkout() {
    if(!confirm("¬øGuardar entrenamiento?")) return;
    stopTimer();
    const title = document.getElementById('active-title').innerText;
    const isoDate = getLocalISO();
    const prettyDate = new Date().toLocaleDateString('es-ES', {weekday:'short', day:'numeric'});
    
    // CAPTURAR CALENTAMIENTO
    const warmChecks = Array.from(document.querySelectorAll('.native-check')).map(c => c.checked ? '‚òë' : '‚òê').join(' ');
    const warmText = warmChecks.includes('‚òë') ? "Calentamiento Realizado" : "Sin Calentar";

    const session = { id:Date.now(), title, isoDate, date:prettyDate, warmup: warmText, data:[], synced:false };
    
    document.querySelectorAll('.ex-card').forEach(card => {
        let sets = [];
        card.querySelectorAll('.set-row').forEach(row => {
            if(row.querySelector('.check-btn').classList.contains('checked')) {
                sets.push({
                    kg: row.querySelector('.val-kg')?.value || '-',
                    reps: row.querySelector('.val-reps')?.value || '-'
                });
            }
        });
        if(sets.length) session.data.push({ name: card.dataset.n, type: card.dataset.t, sets });
    });

    if(!session.data.length) return alert("Anota algo primero");
    
    const h = JSON.parse(localStorage.getItem('pro_tracker_db')) || [];
    h.push(session);
    localStorage.setItem('pro_tracker_db', JSON.stringify(h));
    
    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
    renderStats(); go('home'); forceSync();
}

function saveBodyWeight() {
    const val = parseFloat(document.getElementById('input-bodyweight').value);
    if(!val) return;
    localStorage.setItem('user_weight_current', val);
    localStorage.setItem('user_weight_date', new Date().toLocaleDateString('es-ES',{day:'numeric',month:'short'}));
    
    const log = JSON.parse(localStorage.getItem('weight_log')) || [];
    log.push({ date: getLocalISO(), weight: val, synced: false });
    localStorage.setItem('weight_log', JSON.stringify(log));
    
    document.getElementById('input-bodyweight').value = '';
    renderStats(); forceSync();
}

// 8. TIMER & CALENDAR
let timerI = null, secL = 0;
function startTimer(s) { stopTimer(); secL = s; document.getElementById('rest-timer').classList.remove('hidden'); updT(); timerI = setInterval(()=>{ secL--; updT(); if(secL<=0){stopTimer(); playBeep(); if(navigator.vibrate)navigator.vibrate(200);} }, 1000); }
function stopTimer() { clearInterval(timerI); document.getElementById('rest-timer').classList.add('hidden'); }
function addTime(s) { secL+=s; updT(); }
function updT() { document.getElementById('timer-countdown').innerText = `${Math.floor(secL/60).toString().padStart(2,'0')}:${(secL%60).toString().padStart(2,'0')}`; }
function playBeep() { const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.frequency.value=800; g.gain.value=0.1; o.start(); setTimeout(()=>o.stop(),200); }

function renderCalendar() {
    const y = currentDate.getFullYear(), m = currentDate.getMonth();
    const names = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
    document.getElementById('cal-month-year').innerText = `${names[m]} ${y}`;
    
    const c = document.getElementById('cal-days-container'); c.innerHTML = '';
    const h = JSON.parse(localStorage.getItem('pro_tracker_db')) || [];
    const dates = h.map(x => x.isoDate);
    const fd = new Date(y, m, 1).getDay();
    const dim = new Date(y, m+1, 0).getDate();
    const today = getLocalISO();

    for(let i=0; i<fd; i++) c.innerHTML += `<div class="cal-day" style="opacity:0"></div>`;
    for(let d=1; d<=dim; d++) {
        const iso = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        let cls = iso === today ? 'today' : iso === selectedDateISO ? 'selected' : '';
        if(dates.includes(iso)) cls += ' has-workout';
        
        const el = document.createElement('div'); el.className = `cal-day ${cls}`; el.innerText = d;
        el.onclick = () => { selectedDateISO = iso; renderCalendar(); renderHistoryList(iso); };
        c.appendChild(el);
    }
}
function changeMonth(d) { currentDate.setMonth(currentDate.getMonth()+d); renderCalendar(); }

// 9. HISTORIAL DETALLADO
function renderHistoryList(iso) {
    const h = JSON.parse(localStorage.getItem('pro_tracker_db')) || [];
    const list = document.getElementById('history-list'); list.innerHTML = '';
    
    const [y,m,d] = iso.split('-');
    document.getElementById('history-date-title').innerText = `Actividad del ${d}/${m}`;
    
    const items = h.filter(x => x.isoDate === iso).reverse();
    
    if(!items.length) { list.innerHTML = '<div style="text-align:center;color:#64748b;padding:20px">Nada este d√≠a</div>'; return; }
    
    items.forEach(s => {
        let details = '';
        if(s.warmup) details += `<div style="font-size:11px; color:#fbbf24; margin-bottom:8px">üî• ${s.warmup}</div>`;

        s.data.forEach(ex => {
            details += `<div style="margin-top:10px">
                <div class="hist-ex-title">${ex.name}</div>`;
            
            ex.sets.forEach((set, idx) => {
                let info = '';
                if(ex.type === 'weighted') info = `${set.kg} kg √ó ${set.reps} reps`;
                else if(ex.type === 'body') info = `${set.reps} reps`;
                else info = `${set.reps}`; // tiempo
                
                details += `<div class="hist-set-row">
                    <span class="hist-set-num">Set ${idx+1}</span>
                    <span style="color:white; font-weight:600">${info}</span>
                </div>`;
            });
            details += `</div>`;
        });

        const icon = s.synced ? '<i class="ri-cloud-check-line" style="color:#34d399"></i>' : '<i class="ri-upload-cloud-line" style="color:#fbbf24"></i>';

        list.innerHTML += `
        <div class="card">
            <div class="flex-between" style="margin-bottom:5px; border-bottom:1px solid #334155; padding-bottom:8px">
                <strong>${s.title}</strong>
                <div style="display:flex;gap:10px;align-items:center">
                    ${icon}
                    <button onclick="deleteItem(${s.id})" style="background:none;border:none;color:#f87171;padding:0"><i class="ri-delete-bin-line" style="font-size:18px"></i></button>
                </div>
            </div>
            ${details}
        </div>`;
    });
}

function cancelWorkout() { if(confirm("¬øSalir?")) go('home'); }
function resetApp() { if(confirm("¬øBorrar TODOS los datos?")) { localStorage.clear(); location.reload(); } }

// Init
renderStats();
</script>
</body>
</html>