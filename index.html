<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#020617">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="GYMLOG">
<title>GYMLOG</title>

<link rel="icon" type="image/png" href="img/logo.png">
<link rel="apple-touch-icon" href="img/logo.png">

<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
/* --- 1. VARIABLES & RESET --- */
:root {
    --bg-body: #020617;
    --bg-card: #1e293b;
    --bg-input: #0f172a;
    --primary: #6366f1;
    --primary-glow: rgba(99, 102, 241, 0.4);
    --text-main: #f8fafc;
    --text-muted: #94a3b8;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --radius: 16px;
    --nav-height: 70px;
    --safe-bottom: env(safe-area-inset-bottom);
    --safe-top: env(safe-area-inset-top);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body { 
    margin: 0; background-color: var(--bg-body); color: var(--text-main); 
    font-family: 'Inter', sans-serif; font-size: 14px;
    display: flex; justify-content: center; min-height: 100vh;
    overscroll-behavior-y: none;
}

::-webkit-scrollbar { width: 0px; background: transparent; }

.app-container {
    width: 100%; max-width: 480px; background-color: var(--bg-body);
    min-height: 100vh; position: relative; 
    padding-bottom: calc(var(--nav-height) + var(--safe-bottom) + 20px);
    padding-top: max(var(--safe-top), 20px);
    padding-left: 16px; padding-right: 16px;
    overflow-x: hidden;
}

/* --- 2. HEADER --- */
.header-grid {
    display: grid;
    grid-template-columns: 44px 1fr 44px;
    align-items: center;
    margin-bottom: 24px;
    position: relative;
    z-index: 10;
}
.header-title {
    text-align: center; margin: 0; font-size: 18px; font-weight: 700;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

/* --- 3. COMPONENTES UI --- */
h1 { font-size: 24px; font-weight: 800; margin: 0; letter-spacing: -0.5px; }
h2 { font-size: 18px; font-weight: 700; margin: 0; }
small { color: var(--text-muted); font-size: 12px; font-weight: 500; }

.btn {
    background: var(--primary); color: white; border: none; padding: 14px; border-radius: var(--radius);
    font-weight: 700; font-size: 15px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px;
    width: 100%; transition: transform 0.1s, box-shadow 0.2s; 
    box-shadow: 0 4px 20px var(--primary-glow);
    text-decoration: none;
}
.btn:active { transform: scale(0.96); }
.btn.icon { width: 44px; height: 44px; padding: 0; border-radius: 50%; background: rgba(255,255,255,0.08); box-shadow: none; color: white; backdrop-filter: blur(10px); display:flex; align-items:center; justify-content:center; border:none;}
.btn.small { padding: 8px 14px; font-size: 12px; width: auto; background: transparent; border: 1px solid rgba(255,255,255,0.1); color: var(--primary); box-shadow: none; }
.btn.text { background: none; box-shadow: none; padding: 8px; width: auto; color: var(--text-muted); }
.btn.danger { background: rgba(239, 68, 68, 0.15); border: 1px solid var(--danger); color: var(--danger); box-shadow: none; }
.btn.action-green { background: var(--success); color: #022c22; box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3); border:none; }

/* BOTON YOUTUBE MEJORADO (Compacto) */
.btn.yt { 
    background: rgba(239, 68, 68, 0.15); 
    border: 1px solid rgba(239, 68, 68, 0.4); 
    color: #f87171; 
    padding: 6px 12px; 
    border-radius: 8px; 
    font-size: 11px; 
    font-weight: 700;
    display: inline-flex; 
    align-items: center; 
    justify-content: center;
    gap: 4px; 
    text-decoration: none;
    transition: 0.2s;
    width: 100%; /* Ocupa el ancho de su contenedor */
}
.btn.yt:active { background: rgba(239, 68, 68, 0.25); }

.card { 
    background: var(--bg-card); border-radius: var(--radius); padding: 18px; margin-bottom: 14px; 
    border: 1px solid rgba(255,255,255,0.03); 
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

input, select { 
    background: var(--bg-input); border: 1px solid rgba(255,255,255,0.08); color: white; 
    padding: 12px; border-radius: 12px; text-align: center; width: 100%; 
    font-size: 16px; font-weight: 600; outline: none; font-family: 'Inter', sans-serif;
    transition: border-color 0.2s;
}
input:focus, select:focus { border-color: var(--primary); }

/* --- 4. DIVISORES CON ESPACIO --- */
.divider-title { 
    margin-top: 40px; margin-bottom: 15px; padding-top: 20px; 
    border-top: 1px solid rgba(255,255,255,0.1); 
    font-size: 12px; color: var(--primary); letter-spacing: 1.5px; 
    font-weight: 800; text-transform: uppercase; 
}

/* --- 5. SYNC BADGE --- */
.sync-badge { background: rgba(16, 185, 129, 0.1); color: #34d399; padding: 8px 16px; border-radius: 30px; font-size: 12px; font-weight: 700; display: flex; align-items: center; gap: 8px; cursor: pointer; border: 1px solid rgba(16, 185, 129, 0.2); transition: all 0.2s; box-shadow: 0 0 15px rgba(16, 185, 129, 0.1); }
.sync-badge:active { transform: scale(0.95); background: rgba(16, 185, 129, 0.2); }
.sync-badge.pending { background: rgba(245, 158, 11, 0.1); color: #fbbf24; border-color: rgba(245, 158, 11, 0.2); box-shadow: 0 0 15px rgba(245, 158, 11, 0.1); }
.sync-badge.syncing { background: rgba(99, 102, 241, 0.1); color: #818cf8; border-color: rgba(99, 102, 241, 0.3); box-shadow: 0 0 15px rgba(99, 102, 241, 0.2); }
.sync-badge.error { background: rgba(239, 68, 68, 0.1); color: #f87171; border-color: rgba(239, 68, 68, 0.3); }
.sync-spin { animation: spin 1s linear infinite; } @keyframes spin { 100% { transform: rotate(360deg); } }

/* --- 6. TIMER & NAV --- */
.timer-float { 
    position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
    background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px); 
    border: 1px solid var(--primary); border-radius: 50px; 
    padding: 8px 16px 8px 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); 
    z-index: 2000; display: flex; align-items: center; gap: 15px; width: auto; max-width: 90%;
}
.timer-float.hidden { display: none !important; }

.nav { 
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
    width: calc(100% - 32px); max-width: 440px; 
    background: rgba(30, 41, 59, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-radius: 24px; padding: 10px 10px; 
    display: flex; justify-content: space-between; align-items: center; 
    border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 10px 40px rgba(0,0,0,0.5); 
    z-index: 1000; transition: transform 0.3s;
}
.nav.hidden { transform: translate(-50%, 150%); }

.nav-item { 
    background: none; border: none; color: #64748b; font-size: 10px; font-weight: 600;
    display: flex; flex-direction: column; align-items: center; gap: 4px; 
    cursor: pointer; flex: 1; padding: 8px 0; border-radius: 16px; transition: 0.2s;
}
.nav-item.active { color: var(--primary); background: rgba(99, 102, 241, 0.1); } 
.nav-item i { font-size: 24px; margin-bottom: 2px; }

.bottom-action-bar {
    position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
    width: 100%; max-width: 480px; 
    background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(10px);
    border-top: 1px solid rgba(255,255,255,0.1);
    padding: 16px 20px; padding-bottom: calc(16px + var(--safe-bottom));
    display: flex; justify-content: center; align-items: center;
    z-index: 1000;
}

/* --- 7. LISTAS & CARDS --- */
.warmup-item { 
    display: flex; justify-content: space-between; align-items: center; 
    padding: 12px 16px; background: rgba(255,255,255,0.03); 
    border-radius: 12px; margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.05);
}
input[type="checkbox"].native-check { width: 24px; height: 24px; accent-color: var(--success); cursor: pointer; margin: 0; }

.editor-item-card { padding: 20px; border: 1px solid rgba(255,255,255,0.08); margin-bottom:12px; }
.editor-input-group { display: grid; grid-template-columns: 2fr 1fr; gap: 12px; margin-bottom: 12px; }
.editor-row-note { display: flex; gap: 12px; margin-bottom: 12px; }
.btn-delete-item { width: 48px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; background: rgba(239, 68, 68, 0.15); border: 1px solid var(--danger); border-radius: 12px; color: var(--danger); cursor:pointer;}

.sets-header { display: grid; gap: 10px; font-size: 11px; color: var(--text-muted); text-align: center; margin-bottom: 8px; font-weight: 700; padding: 0 4px; text-transform: uppercase; letter-spacing: 0.5px; }
.set-row { margin-bottom: 10px; align-items: center; display: grid; gap: 10px; }
.grid-weighted { grid-template-columns: 24px 1fr 1fr 48px; }
.grid-simple { grid-template-columns: 24px 1fr 48px; }
.set-num { text-align: center; color: var(--text-muted); font-weight: 600; font-size: 12px; }

.check-btn { 
    width: 100%; height: 46px; border-radius: 12px; 
    background: var(--bg-input); border: 1px solid rgba(255,255,255,0.08); 
    display: flex; align-items: center; justify-content: center; 
    cursor: pointer; transition: all 0.2s; 
}
.check-btn.checked { background: var(--success); border-color: var(--success); transform: scale(0.95); }
.check-btn i { opacity: 0; transform: scale(0.5); transition: 0.2s; color: #022c22; font-weight: 900; font-size: 22px; }
.check-btn.checked i { opacity: 1; transform: scale(1); }

.flex-between { display: flex; justify-content: space-between; align-items: center; }
.hidden { display: none !important; }
.tag { padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 800; text-transform: uppercase; }
.tag.blue { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }

/* TOAST */
.toast {
    position: fixed; top: 90px; left: 50%; transform: translateX(-50%) translateY(-20px);
    background: rgba(16, 185, 129, 0.95); color: #022c22; padding: 12px 24px;
    border-radius: 30px; font-weight: 700; box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    opacity: 0; transition: all 0.4s; pointer-events: none; z-index: 3000; 
    display: flex; align-items: center; gap: 8px; font-size: 14px; backdrop-filter: blur(10px); width: max-content;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

.tools-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); z-index: 2500; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; }
.tools-modal.active { display: flex; opacity: 1; }
.tools-content { background: var(--bg-card); width: 90%; max-width: 340px; border-radius: 24px; padding: 24px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 50px rgba(0,0,0,0.5); transform: scale(0.9); transition: transform 0.2s; }
.tools-modal.active .tools-content { transform: scale(1); }

.view-toggle { display: flex; background: var(--bg-input); padding: 4px; border-radius: 14px; margin-bottom: 20px; }
.view-toggle button { flex: 1; padding: 10px; border-radius: 10px; background: transparent; border: none; color: var(--text-muted); font-weight: 600; transition: 0.2s; }
.view-toggle button.active { background: var(--bg-card); color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
.filter-tabs { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding: 4px; scrollbar-width: none; }
.filter-tab { background: var(--bg-card); border: 1px solid rgba(255,255,255,0.05); padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; white-space: nowrap; transition: 0.2s; color: var(--text-muted); }
.filter-tab.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 15px var(--primary-glow); }

.cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center; margin-top: 15px; }
.cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 12px; font-weight: 600; background: rgba(255,255,255,0.02); border: 1px solid transparent; }
.cal-day.today { border-color: var(--primary); color: var(--primary); }
.cal-day.has-workout { background: rgba(16, 185, 129, 0.15); color: var(--success); border-color: rgba(16, 185, 129, 0.3); }
.cal-day.selected { background: var(--primary) !important; color: white !important; border-color: transparent; box-shadow: 0 4px 15px var(--primary-glow); }

.history-card { cursor: pointer; transition: background 0.2s; }
.history-card:active { background: var(--surface-hover); }
.history-header { display: flex; align-items: center; gap: 15px; }
.history-date-box { background: rgba(255,255,255,0.05); border-radius: 10px; padding: 8px 12px; text-align: center; min-width: 60px; border: 1px solid rgba(255,255,255,0.1); }
.history-day-num { font-size: 18px; font-weight: 800; color: var(--primary); line-height: 1; }
.history-day-name { font-size: 10px; text-transform: uppercase; color: var(--text-muted); font-weight: 700; margin-top: 2px; }
.history-info { flex-grow: 1; }
.history-title { font-weight: 700; font-size: 15px; margin-bottom: 4px; }
.history-meta { font-size: 11px; color: var(--text-muted); display: flex; gap: 10px; }
.history-details { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px dashed rgba(255,255,255,0.1); animation: slideDown 0.2s ease-out; }
.history-card.expanded .history-details { display: block; }
@keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
.hist-ex-title { color: white; font-weight: 700; font-size: 14px; margin-bottom: 6px; }
.hist-set-row { display: flex; justify-content: space-between; font-size: 12px; color: #94a3b8; border-bottom: 1px solid rgba(255,255,255,0.03); padding: 6px 0; }
.pr-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
.pr-value { color: var(--success); font-weight: 800; background: rgba(16, 185, 129, 0.1); padding: 4px 10px; border-radius: 6px; font-size: 13px; }

.screen { display: none; animation: fadeUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
.screen.active { display: block; }
@keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwcqHNwPq6JReM8BJMAvyhuo2JhsVrNJeDj64TQBplxpF6SDkFkvPeCiSAHz564OGqG/exec"; 
</script>

<div id="toast-msg" class="toast"><i class="ri-checkbox-circle-fill"></i> <span>Mensaje</span></div>

<div id="tools-modal" class="tools-modal" onclick="if(event.target===this)closeTools()">
    <div class="tools-content">
        <div class="flex-between" style="margin-bottom:20px">
            <h3 style="margin:0">Calculadora 1RM</h3>
            <button class="btn icon small" onclick="closeTools()"><i class="ri-close-line"></i></button>
        </div>
        <div style="text-align:center">
            <div class="flex-between" style="gap:15px; margin-top:15px">
                <div style="flex:1"><input type="number" id="rm-kg" placeholder="0" style="font-size:24px"><div style="font-size:10px;color:var(--text-muted);margin-top:5px">Peso (kg)</div></div>
                <div style="flex:1"><input type="number" id="rm-reps" placeholder="0" style="font-size:24px"><div style="font-size:10px;color:var(--text-muted);margin-top:5px">Reps</div></div>
            </div>
            <button class="btn" style="margin-top:20px" onclick="calc1RM()">Calcular Fuerza M√°xima</button>
            <div id="rm-result" style="margin-top:20px;padding:15px;background:rgba(255,255,255,0.05);border-radius:12px;display:none;font-weight:bold;color:var(--success)"></div>
        </div>
    </div>
</div>

<div id="rest-timer" class="timer-float hidden">
    <div><small style="color:#94a3b8">Descanso</small><div id="timer-countdown" style="font-weight:800;font-size:24px;color:white;font-variant-numeric:tabular-nums">01:30</div></div>
    <div style="width:1px; height:30px; background:rgba(255,255,255,0.1)"></div>
    <div class="flex-between" style="gap:10px">
        <button class="btn small" style="width:40px;height:40px;border-radius:12px;border:1px solid rgba(255,255,255,0.2);color:white;padding:0" onclick="addTime(30)">+30</button>
        <button class="btn small" style="width:40px;height:40px;border-radius:12px;border:1px solid #ef4444;color:#ef4444;padding:0" onclick="stopTimer()"><i class="ri-stop-fill"></i></button>
    </div>
</div>

<div class="app-container">

    <div id="home" class="screen active">
        <div class="flex-between" style="margin-bottom:25px">
            <div><small>Bienvenido</small><h1>Hola, Atleta ‚ö°</h1></div>
            <div id="sync-status" class="sync-badge" onclick="forceSync()"><i class="ri-cloud-line"></i> <span>Al d√≠a</span></div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-bottom:20px">
            <div class="card" style="margin:0; padding:15px 10px; text-align:center">
                <div id="current-weight-display" style="color:var(--success);font-weight:800;font-size:18px">--</div><small>Peso</small>
            </div>
            <div class="card" style="margin:0; padding:15px 10px; text-align:center; cursor:pointer" onclick="editGoalWeight()">
                <div id="goal-weight-display" style="color:white;font-weight:800;font-size:18px">--</div><small>Meta <i class="ri-pencil-fill" style="font-size:10px"></i></small>
            </div>
            <div class="card" style="margin:0; padding:15px 10px; text-align:center">
                <div id="total-sessions" style="color:var(--primary);font-weight:800;font-size:18px">0</div><small>Sesiones</small>
            </div>
        </div>

        <button class="btn" onclick="go('stats')" style="margin: 10px 0 25px 0; background:#1e293b; border:1px solid #334155;">
            <i class="ri-bar-chart-box-line" style="color:var(--primary)"></i> Ver Estad√≠sticas Completas
        </button>

        <h3 style="margin:0 0 15px 0; color:var(--text-muted); font-size:13px; letter-spacing:1px; text-transform:uppercase">Entrenar Hoy</h3>
        <div id="routines-list"></div>
        <button class="btn text" onclick="resetApp()" style="margin: 40px auto; display:block; font-size:12px; opacity:0.4">Resetear Todo</button>
    </div>

    <div id="editor" class="screen" style="padding-bottom:100px">
        <div class="header-grid" style="margin-bottom: 20px;">
            <div style="width:44px"></div> 
            <h2 class="header-title">Mis Rutinas</h2>
            <button class="btn icon small action-green" onclick="createNewRoutine()"><i class="ri-add-line"></i></button>
        </div>
        <div id="editor-list"></div>
    </div>

    <div id="history" class="screen" style="padding-bottom:100px">
        <div class="flex-between" style="margin-bottom:20px">
            <h2>Historial</h2>
            <div id="sync-status-hist" class="sync-badge" onclick="downloadData()">
                <i class="ri-refresh-line"></i> <span>Sync</span>
            </div>
        </div>
        <div class="view-toggle">
            <button id="view-timeline-btn" class="active" onclick="toggleHistoryView('timeline')">Lista</button>
            <button id="view-calendar-btn" onclick="toggleHistoryView('calendar')">Calendario</button>
        </div>
        <div id="history-calendar-view" class="hidden">
            <div class="card">
                <div class="flex-between" style="margin-bottom:10px">
                    <button class="btn icon small" onclick="changeMonth(-1)"><i class="ri-arrow-left-s-line"></i></button>
                    <span id="cal-month-year" style="font-weight:700; font-size:16px; text-transform:capitalize">Mes</span>
                    <button class="btn icon small" onclick="changeMonth(1)"><i class="ri-arrow-right-s-line"></i></button>
                </div>
                <div class="cal-grid">
                    <small>D</small><small>L</small><small>M</small><small>M</small><small>J</small><small>V</small><small>S</small>
                    <div id="cal-days-container" style="display:contents"></div>
                </div>
            </div>
            <div id="calendar-day-details" style="margin-top:20px"></div>
        </div>
        <div id="history-timeline-view"><div id="history-list"></div></div>
    </div>

    <div id="stats" class="screen" style="padding-bottom:100px">
        <h2 style="margin-bottom:20px">Progreso</h2>
        <div class="filter-tabs">
            <div class="filter-tab active" onclick="setStatsRange('1M', this)">30 D√≠as</div>
            <div class="filter-tab" onclick="setStatsRange('3M', this)">3 Meses</div>
            <div class="filter-tab" onclick="setStatsRange('6M', this)">6 Meses</div>
            <div class="filter-tab" onclick="setStatsRange('ALL', this)">Todo</div>
        </div>
        <div class="card">
            <div class="flex-between" style="margin-bottom:15px">
                <strong style="color:#6ee7b7"><i class="ri-scales-3-line"></i> Peso Corporal</strong>
                <small id="last-weight-date">--</small>
            </div>
            <div style="height:180px; width:100%"><canvas id="weightChart"></canvas></div>
            <div class="flex-between" style="gap:10px; margin-top:15px; padding-top:15px; border-top:1px solid rgba(255,255,255,0.05)">
                <input type="number" id="input-bodyweight" placeholder="Kg hoy" style="text-align:center">
                <button class="btn small action-green" onclick="saveBodyWeight()">Guardar</button>
            </div>
        </div>
        <div class="card">
            <strong style="display:block; margin-bottom:15px; color:#a5b4fc"><i class="ri-bar-chart-fill"></i> Volumen (Kg)</strong>
            <div style="height:150px; width:100%"><canvas id="fullVolumeChart"></canvas></div>
        </div>
        <div class="card">
            <strong style="display:block; margin-bottom:15px; color:#fbbf24"><i class="ri-calendar-event-fill"></i> Frecuencia</strong>
            <div style="height:150px; width:100%"><canvas id="consistencyChart"></canvas></div>
        </div>
        <div class="card">
            <strong style="display:block; margin-bottom:15px; color:#fbbf24"><i class="ri-trophy-line"></i> R√©cords (PR)</strong>
            <div id="pr-container"></div>
        </div>
    </div>

    <div id="training" class="screen" style="padding-bottom:100px">
        <div class="header-grid">
            <button class="btn icon small" onclick="cancelWorkout()"><i class="ri-close-line"></i></button>
            <h2 id="active-title" class="header-title">Rutina</h2>
            <button class="btn icon small" onclick="openTools()" style="background:rgba(255,255,255,0.1)"><i class="ri-calculator-line"></i></button>
        </div>
        
        <div class="card" style="border-left:3px solid var(--warning); padding:12px">
            <div class="flex-between" onclick="document.getElementById('warmup-items').classList.toggle('hidden')" style="cursor:pointer">
                <strong style="font-size:13px; color:var(--warning)">üî• CALENTAMIENTO</strong> <i class="ri-arrow-down-s-line"></i>
            </div>
            <div id="warmup-items" class="hidden" style="margin-top:10px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.1)"></div>
        </div>
        <div id="workout-container"></div>
        
        <div class="bottom-action-bar">
            <button class="btn action-green" style="width:100%; max-width:320px; font-size:16px; padding:16px" onclick="finishWorkout()">TERMINAR ENTRENAMIENTO <i class="ri-check-double-line"></i></button>
        </div>
    </div>

    <div id="editor-detail" class="screen" style="padding-bottom:100px">
        <div class="header-grid">
            <button class="btn icon small" onclick="go('editor')"><i class="ri-arrow-left-line"></i></button>
            <h2 class="header-title">Editar Rutina</h2>
            <div style="width:44px"></div> 
        </div>

        <input type="text" id="routine-title-input" placeholder="Nombre Rutina" style="font-size:18px; font-weight:700; margin-bottom:10px; text-align:left">
        <input type="text" id="routine-tag-input" placeholder="Etiqueta (ej: Lunes)" style="font-size:14px; margin-bottom:20px; background:rgba(255,255,255,0.03); text-align:left">

        <div class="divider-title">CALENTAMIENTO</div>
        <div id="editor-warmup-list"></div>
        <button class="btn small" onclick="addWarmupInput()" style="margin:10px 0; border-style:dashed; opacity:0.7; width:100%">+ Agregar</button>

        <div class="divider-title" style="margin-top:30px">EJERCICIOS</div>
        <div id="routine-exercises-list"></div>
        <button class="btn small" onclick="addExerciseInput()" style="margin:20px 0; border-color:var(--primary); color:var(--primary); width:100%">+ Agregar Ejercicio</button>
        
        <button class="btn text danger" id="delete-routine-btn" style="margin-top:40px; width:100%"><i class="ri-delete-bin-line"></i> Eliminar esta Rutina</button>
        
        <div class="bottom-action-bar">
            <button class="btn action-green" style="width:100%; max-width:320px" onclick="saveRoutineDetail()">Guardar Cambios</button>
        </div>
    </div>

    <nav id="navbar" class="nav">
        <button class="nav-item active" onclick="go('home')"><i class="ri-home-5-line"></i>Inicio</button>
        <button class="nav-item" onclick="go('editor')"><i class="ri-list-settings-line"></i>Rutinas</button>
        <button class="nav-item" onclick="go('history')"><i class="ri-time-line"></i>Historial</button>
        <button class="nav-item" onclick="go('stats')"><i class="ri-bar-chart-line"></i>Progreso</button>
    </nav>
</div>

<script>
// === LOGICA ===
let ROUTINES = JSON.parse(localStorage.getItem('pro_tracker_routines')) || {};
let historyViewMode = 'timeline'; 
let statsRange = '1M'; 
if (!ROUTINES.config_app) ROUTINES.config_app = { goal: 78 }; 
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let currentDate = new Date(), selectedDateISO = getLocalISO(), currentRoutineId = null;

function getLocalISO(d=new Date()){ const z=d.getTimezoneOffset()*60*1000; return new Date(d-z).toISOString().split('T')[0]; }

function go(id){
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
    const navMap = {'home':0, 'editor':1, 'history':2, 'stats':3};
    if(navMap[id] !== undefined) document.querySelectorAll('.nav-item')[navMap[id]].classList.add('active');
    const nav = document.getElementById('navbar');
    
    if(id==='home') renderRoutinesHome();
    if(id==='history') { if(historyViewMode === 'calendar') renderCalendar(); else renderTimeline(); }
    if(id==='editor') renderEditorList();
    if(id==='stats') renderDetailedStats();
    
    if(['training','editor-detail'].includes(id)) nav.classList.add('hidden'); else nav.classList.remove('hidden');
}

function showToast(msg) {
    const t = document.getElementById('toast-msg');
    t.querySelector('span').innerText = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
}

function updateSyncUI(s){
    const elements = [document.getElementById('sync-status'), document.getElementById('sync-status-hist')];
    elements.forEach(el => {
        if(!el) return;
        const i = el.querySelector('i');
        const t = el.querySelector('span');
        el.className = 'sync-badge'; i.className = '';
        if(s === 'synced'){ el.className += ''; i.className = 'ri-cloud-check-line'; t.innerText = "Al d√≠a"; }
        else if(s === 'syncing'){ el.className += ' syncing'; i.className = 'ri-loader-4-line sync-spin'; t.innerText = "Sync..."; }
        else if(s === 'pending'){ el.className += ' pending'; i.className = 'ri-cloud-off-line'; t.innerText = "Guardar"; }
        else { el.className += ' error'; i.className = 'ri-error-warning-line'; t.innerText = "Error"; }
    });
}

async function forceSync() {
    if(API_URL.includes("GOOGLE")) { showToast("Configura la URL"); return; } 
    if(!navigator.onLine) { showToast("Modo Offline"); return; }
    updateSyncUI('syncing');
    try {
        const h=JSON.parse(localStorage.getItem('pro_tracker_db'))||[], w=JSON.parse(localStorage.getItem('weight_log'))||[];
        const uH=h.filter(x=>!x.synced), uW=w.filter(x=>!x.synced);
        if(uH.length>0||uW.length>0){ 
            for(let s of uH){await fetch(API_URL,{method:'POST',mode:'no-cors',body:JSON.stringify({action:'save_workout',...s})});s.synced=true;}
            localStorage.setItem('pro_tracker_db',JSON.stringify(h));
            for(let i of uW){await fetch(API_URL,{method:'POST',mode:'no-cors',body:JSON.stringify({action:'save_weight',date:i.date,weight:i.weight})});i.synced=true;}
            localStorage.setItem('weight_log',JSON.stringify(w));
        }
        
        const localR = JSON.parse(localStorage.getItem('pro_tracker_routines'));
        if(localR) await fetch(API_URL,{method:'POST',mode:'no-cors',body:JSON.stringify({action:'save_routines',payload:localR})});

        const res=await fetch(API_URL); const cloud=await res.json();
        
        const mapH=new Map(); cloud.history.forEach(x=>mapH.set(x.id,x)); h.forEach(x=>{if(!mapH.has(x.id))mapH.set(x.id,x)}); 
        localStorage.setItem('pro_tracker_db',JSON.stringify(Array.from(mapH.values())));
        
        if(cloud.weights?.length){
            localStorage.setItem('weight_log',JSON.stringify(cloud.weights)); 
            const l=cloud.weights[cloud.weights.length-1]; 
            localStorage.setItem('user_weight_current',l.weight); 
            localStorage.setItem('user_weight_date',new Date(l.date).toLocaleDateString('es-ES',{day:'numeric',month:'short'}));
        }
        
        if(cloud.routines) {
            localStorage.setItem('pro_tracker_routines', JSON.stringify(cloud.routines));
            ROUTINES = cloud.routines;
            if (!ROUTINES.config_app) ROUTINES.config_app = { goal: 78 };
            renderRoutinesHome();
        }

        updateSyncUI('synced'); confetti({particleCount:50,spread:60,origin:{y:0.1},colors:['#10b981']}); 
        renderStats(); if(selectedDateISO) renderTimeline();
        showToast("Sincronizado");
    } catch(e){ console.error(e); updateSyncUI('error'); showToast("Error de conexi√≥n"); }
}
async function downloadData(){await forceSync();}

function renderRoutinesHome() {
    const c = document.getElementById('routines-list'); c.innerHTML = '';
    const keys = Object.keys(ROUTINES).filter(k => k !== 'config_app'); 
    if(keys.length === 0) { c.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted)">No tienes rutinas.<br>Ve a la pesta√±a "Rutinas" para crear una.</div>'; return; }
    keys.forEach(id => {
        const r = ROUTINES[id]; const tag = r.tag ? `<span class="tag blue">${r.tag}</span>` : '';
        c.innerHTML += `<div class="card" onclick="startWorkout('${id}')" style="cursor:pointer; display:flex; justify-content:space-between; align-items:center">
            <div>${tag}<h3 style="margin:5px 0 0 0">${r.title}</h3><small>${(r.exercises||[]).length} Ejercicios</small></div>
            <button class="btn icon action-green"><i class="ri-play-fill"></i></button>
        </div>`;
    });
}

function renderEditorList() {
    const c = document.getElementById('editor-list'); c.innerHTML = '';
    Object.keys(ROUTINES).filter(k => k !== 'config_app').forEach(id => {
        c.innerHTML += `<div class="card flex-between" onclick="editRoutine('${id}')"><strong>${ROUTINES[id].title}</strong><i class="ri-arrow-right-s-line" style="color:var(--text-muted)"></i></div>`;
    });
}

function createNewRoutine() { currentRoutineId = 'custom_' + Date.now(); ROUTINES[currentRoutineId] = { title: "", tag:"", warmup:[], exercises: [] }; editRoutine(currentRoutineId); }

function editRoutine(id) {
    currentRoutineId = id; const r = ROUTINES[id];
    document.getElementById('routine-title-input').value = r.title;
    document.getElementById('routine-tag-input').value = r.tag || "";
    
    const wList = document.getElementById('editor-warmup-list'); wList.innerHTML = '';
    (r.warmup || []).forEach(w => addWarmupInput(w));

    const list = document.getElementById('routine-exercises-list'); list.innerHTML = '';
    r.exercises.forEach(ex => addExerciseInput(ex));
    go('editor-detail');
}

function addWarmupInput(val = "") {
    const div = document.createElement('div'); div.className = 'warmup-item'; 
    div.style.cursor = 'default';
    div.innerHTML = `
        <input type="text" class="warmup-val" value="${val}" placeholder="Actividad" style="text-align:left; background:transparent; border:none; width:100%">
        <button class="btn icon small" onclick="this.parentElement.remove()" style="color:var(--danger); width:32px; height:32px; border-color:var(--danger)"><i class="ri-delete-bin-line"></i></button>
    `;
    document.getElementById('editor-warmup-list').appendChild(div);
}

function addExerciseInput(ex = null) {
    const div = document.createElement('div'); div.className = 'card editor-item-card';
    div.innerHTML = `
        <div class="editor-input-group"><input type="text" placeholder="Nombre Ejercicio" class="ex-name" value="${ex?.name||''}" style="text-align:left"><select class="ex-type"><option value="weighted" ${ex?.type==='weighted'?'selected':''}>Con Peso</option><option value="body" ${ex?.type==='body'?'selected':''}>Corporal</option><option value="time" ${ex?.type==='time'?'selected':''}>Tiempo</option></select></div>
        <div class="editor-row-note"><input type="text" placeholder="Nota (ej: Codos 45¬∞)" class="ex-note" value="${ex?.note||''}"><button class="btn-delete-item" onclick="this.closest('.editor-item-card').remove()"><i class="ri-delete-bin-line"></i></button></div>
        <div><input type="text" placeholder="Link YouTube (opcional)" class="ex-url" value="${ex?.url||''}" style="text-align:left; font-size:12px; opacity:0.6; background:transparent; border:1px dashed rgba(255,255,255,0.1)"></div>`;
    document.getElementById('routine-exercises-list').appendChild(div);
}

function saveRoutineDetail() {
    const title = document.getElementById('routine-title-input').value.trim(); if(!title) return showToast("Falta el nombre");
    const tag = document.getElementById('routine-tag-input').value.trim();
    const warmup = [];
    document.querySelectorAll('.warmup-val').forEach(inp => { if(inp.value.trim()) warmup.push(inp.value.trim()); });
    const exercises = [];
    document.querySelectorAll('.editor-item-card').forEach(card => {
        const name = card.querySelector('.ex-name').value.trim();
        if(name) {
            exercises.push({ 
                name, type: card.querySelector('.ex-type').value, 
                note: card.querySelector('.ex-note').value.trim(), url: card.querySelector('.ex-url').value.trim()
            });
        }
    });
    // FIX: Permitir guardar si tiene al menos un item (ejercicio o calentamiento)
    if(!exercises.length && !warmup.length) return showToast("Agrega ejercicios o calentamiento");

    ROUTINES[currentRoutineId] = { title, tag, warmup, exercises }; 
    localStorage.setItem('pro_tracker_routines', JSON.stringify(ROUTINES));
    go('editor'); updateSyncUI('pending');
}

function deleteRoutine(id) { 
    if(confirm("¬øEliminar esta rutina para siempre?")) {
        delete ROUTINES[id]; localStorage.setItem('pro_tracker_routines', JSON.stringify(ROUTINES)); go('editor'); updateSyncUI('pending');
    }
}

function openTools() { document.getElementById('tools-modal').classList.add('active'); }
function closeTools() { document.getElementById('tools-modal').classList.remove('active'); }

function calc1RM() {
    const kg = parseFloat(document.getElementById('rm-kg').value);
    const reps = parseFloat(document.getElementById('rm-reps').value);
    if (!kg || !reps) return;
    const rm = Math.round(kg * (1 + (reps / 30)));
    const res = document.getElementById('rm-result');
    res.style.display = 'block';
    res.innerHTML = `1RM Estimado: ${rm} kg`;
}

function getLastLog(exName) {
    const h = JSON.parse(localStorage.getItem('pro_tracker_db')) || [];
    for (let i = h.length - 1; i >= 0; i--) {
        const session = h[i];
        const exercise = session.data.find(e => e.name === exName);
        if (exercise) {
            const bestSet = exercise.sets[0]; 
            if(bestSet.kg && bestSet.kg !== '-') return `${bestSet.kg}kg √ó ${bestSet.reps}`;
            return `${bestSet.reps} reps`;
        }
    }
    return null;
}

function startWorkout(id) {
    if(audioCtx.state === 'suspended') audioCtx.resume();
    const t = ROUTINES[id]; currentRoutineId = id;
    document.getElementById('active-title').innerText = t.title;
    const currentWarmup = t.warmup || []; 
    const wContainer = document.getElementById('warmup-items');
    if (currentWarmup.length === 0) {
        wContainer.innerHTML = '<div style="text-align:center; padding:10px; color:#64748b; font-size:12px">Sin calentamiento espec√≠fico</div>';
    } else {
        wContainer.innerHTML = currentWarmup.map(w => `<label class="warmup-item"><span>${w}</span><input type="checkbox" class="native-check"></label>`).join('');
    }
    const c = document.getElementById('workout-container'); c.innerHTML = '';
    t.exercises.forEach(ex => {
        const ytBtn = ex.url ? `<a href="${ex.url}" target="_blank" class="btn yt"><i class="ri-youtube-fill"></i> Video</a>` : '';
        const lastLog = getLastLog(ex.name);
        const lastLogHtml = lastLog ? `<div style="font-size:11px; color:#94a3b8; font-weight:500; margin-top:4px; display:flex; align-items:center; gap:4px"><i class="ri-history-line"></i> ${lastLog}</div>` : '';
        let head = '', btnTxt = ex.type==='time' ? '+ Tiempo' : '+ Set';
        if(ex.type==='weighted') head = `<div class="sets-header grid-weighted"><span>#</span><span>KG</span><span>REPS</span><span>OK</span></div>`;
        else head = `<div class="sets-header grid-simple"><span>#</span><span>${ex.type==='time'?'TIEMPO':'REPS'}</span><span>OK</span></div>`;
        
        // MODIFICADO: Layout de Cabecera de Tarjeta
        c.innerHTML += `<div class="card ex-card" data-n="${ex.name}" data-t="${ex.type}">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px">
                <div style="flex:1; padding-right:10px">
                    <strong style="font-size:16px; display:block; margin-bottom:4px; line-height:1.3">${ex.name}</strong>
                    ${lastLogHtml}
                    <div style="font-size:11px;color:var(--warning);margin-top:4px">${ex.note}</div>
                </div>
                <div style="display:flex; flex-direction:column; align-items:flex-end; gap:8px; min-width:80px">
                    ${ytBtn}
                    <button class="btn small" onclick="addSet(this, '${ex.type}')">${btnTxt}</button>
                </div>
            </div>
            <div style="margin-top:15px">${head}<div class="sets"></div></div>
        </div>`;
    });
    go('training');
}

function addSet(btn, type) {
    const card = btn.closest('.ex-card');
    const w = card.querySelector('.sets');
    const n = w.children.length + 1;
    const d = document.createElement('div');
    let inp = type === 'weighted' ? `<input type="number" placeholder="kg" class="val-kg"><input type="number" placeholder="reps" class="val-reps">` : `<input type="${type === 'time' ? 'text' : 'number'}" placeholder="${type === 'time' ? '30s' : 'Reps'}" class="val-reps">`;
    d.className = `set-row ${type} ${type === 'weighted' ? 'grid-weighted' : 'grid-simple'}`;
    d.innerHTML = `<span class="set-num">${n}</span>${inp}<div class="check-btn" onclick="toggleCheck(this)"><i class="ri-check-line"></i></div>`;
    w.appendChild(d);
}

function toggleCheck(el) {
    el.classList.toggle('checked'); const i=el.parentElement.querySelectorAll('input');
    if(el.classList.contains('checked')){
        i.forEach(x=>x.style.opacity=0.5); startTimer(90); if(navigator.vibrate) navigator.vibrate(50);
    } else i.forEach(x=>x.style.opacity=1);
}

function finishWorkout() {
    stopTimer();
    const title = document.getElementById('active-title').innerText, isoDate = getLocalISO(), prettyDate = new Date().toLocaleDateString('es-ES', {weekday:'short', day:'numeric'});
    const session = { id:Date.now(), title, isoDate, date:prettyDate, warmup: "Completado", data:[], synced:false };
    let hasData = false;
    document.querySelectorAll('.ex-card').forEach(card => {
        let sets = [];
        card.querySelectorAll('.set-row').forEach(row => {
            if(row.querySelector('.check-btn').classList.contains('checked')) {
                const kg = row.querySelector('.val-kg')?.value || '-';
                const reps = row.querySelector('.val-reps')?.value || '-';
                if(kg !== '-' || reps !== '-') sets.push({ kg, reps });
            }
        });
        if(sets.length) { session.data.push({ name: card.dataset.n, type: card.dataset.t, sets }); hasData = true; }
    });
    if(!hasData) return showToast("Registra al menos un set");
    const h = JSON.parse(localStorage.getItem('pro_tracker_db')) || []; h.push(session); localStorage.setItem('pro_tracker_db', JSON.stringify(h));
    confetti({particleCount:100, spread:70, origin:{y:0.6}}); 
    go('home'); forceSync(); showToast("¬°Buen trabajo! üí™");
}

function saveBodyWeight() {
    const v = parseFloat(document.getElementById('input-bodyweight').value); if(!v) return;
    localStorage.setItem('user_weight_current', v); localStorage.setItem('user_weight_date', new Date().toLocaleDateString('es-ES',{day:'numeric',month:'short'}));
    const l = JSON.parse(localStorage.getItem('weight_log')) || []; l.push({ date: getLocalISO(), weight: v, synced: false }); localStorage.setItem('weight_log', JSON.stringify(l));
    document.getElementById('input-bodyweight').value = ''; renderStats(); forceSync(); showToast("Peso guardado");
}

function editGoalWeight() {
    const current = ROUTINES.config_app ? ROUTINES.config_app.goal : 78;
    const newGoal = prompt("Define tu Meta (kg):", current);
    if (newGoal && !isNaN(newGoal)) {
        if (!ROUTINES.config_app) ROUTINES.config_app = {};
        ROUTINES.config_app.goal = parseFloat(newGoal);
        localStorage.setItem('pro_tracker_routines', JSON.stringify(ROUTINES));
        renderStats(); updateSyncUI('pending');
    }
}

let timerI=null,secL=0; function startTimer(s){stopTimer();secL=s;document.getElementById('rest-timer').classList.remove('hidden');ut();timerI=setInterval(()=>{secL--;ut();if(secL<=0){stopTimer();playBeep();}},1000);} function stopTimer(){clearInterval(timerI);document.getElementById('rest-timer').classList.add('hidden');} function addTime(s){secL+=s;ut();} function ut(){const m=Math.floor(secL/60).toString().padStart(2,'0'),s=(secL%60).toString().padStart(2,'0');document.getElementById('timer-countdown').innerText=`${m}:${s}`;} function playBeep(){const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.frequency.value=800;g.gain.value=0.1;o.start();setTimeout(()=>o.stop(),200);}

let chart=null, fullVolumeChart=null, consistencyChart=null;

function setStatsRange(range, el) {
    statsRange = range;
    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    renderDetailedStats();
}

function renderDetailedStats() {
    const h = JSON.parse(localStorage.getItem('pro_tracker_db')) || [];
    const wLog = JSON.parse(localStorage.getItem('weight_log')) || [];
    const now = new Date();
    let cutoff = new Date(0); 
    if(statsRange === '1M') cutoff = new Date(now.setMonth(now.getMonth() - 1));
    else if(statsRange === '3M') cutoff = new Date(now.setMonth(now.getMonth() - 3));
    else if(statsRange === '6M') cutoff = new Date(now.setMonth(now.getMonth() - 6));
    const filteredH = h.filter(s => new Date(s.isoDate) >= cutoff);
    const filteredW = wLog.filter(w => new Date(w.date) >= cutoff);

    const ctx = document.getElementById('weightChart');
    if(ctx){
        if(chart) chart.destroy();
        const grad = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
        grad.addColorStop(0, 'rgba(16, 185, 129, 0.5)'); grad.addColorStop(1, 'rgba(16, 185, 129, 0)');
        chart = new Chart(ctx,{type:'line',data:{labels:filteredW.map(x=>x.date.slice(5)),datasets:[{data:filteredW.map(x=>x.weight),borderColor:'#10b981',backgroundColor:grad,borderWidth:2,tension:0.4,fill:true,pointRadius:3,pointBackgroundColor:'#064e3b'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{display:false},y:{grid:{color:'#334155'}}}}});
    }

    const ctxVol = document.getElementById('fullVolumeChart');
    if (ctxVol) {
        if(fullVolumeChart) fullVolumeChart.destroy();
        const gradVol = ctxVol.getContext('2d').createLinearGradient(0, 0, 0, 400);
        gradVol.addColorStop(0, 'rgba(99, 102, 241, 0.5)'); gradVol.addColorStop(1, 'rgba(99, 102, 241, 0)');
        const d = filteredH.map(s => {
            let vol = 0; s.data.forEach(ex => { if(ex.type === 'weighted') ex.sets.forEach(st => { vol += (parseFloat(st.kg)||0)*(parseFloat(st.reps)||0); }); });
            return { date: s.date, vol: Math.round(vol) };
        });
        fullVolumeChart = new Chart(ctxVol, {type: 'line', data: { labels: d.map(x => x.date), datasets: [{ label: 'Volumen', data: d.map(x => x.vol), borderColor: '#6366f1', backgroundColor: gradVol, fill: true, tension: 0.3, pointRadius: 2 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { grid: { color: '#334155' } } }, plugins: { legend: { display: false } } } });
    }

    const ctxCon = document.getElementById('consistencyChart');
    if (ctxCon) {
        if(consistencyChart) consistencyChart.destroy();
        let labels = [], data = [];
        if (statsRange === '1M') {
            const daysMap = {}; filteredH.forEach(s => { daysMap[s.date] = (daysMap[s.date] || 0) + 1; });
            labels = Object.keys(daysMap); data = Object.values(daysMap);
        } else {
            const months = {}; filteredH.forEach(s => { const m = s.isoDate.substring(0, 7); months[m] = (months[m] || 0) + 1; });
            labels = Object.keys(months).sort(); data = labels.map(l => months[l]);
        }
        consistencyChart = new Chart(ctxCon, {type: 'bar', data: { labels: labels, datasets: [{ data: data, backgroundColor: '#fbbf24', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 }, grid: { color: '#334155' } } }, plugins: { legend: { display: false } } } });
    }

    const prContainer = document.getElementById('pr-container');
    prContainer.innerHTML = '';
    const maxLifts = {};
    h.forEach(session => { session.data.forEach(ex => { if (ex.type === 'weighted') { ex.sets.forEach(set => { const kg = parseFloat(set.kg) || 0; if (kg > (maxLifts[ex.name] || 0)) maxLifts[ex.name] = kg; }); } }); });
    const sortedExercises = Object.keys(maxLifts).sort();
    if (sortedExercises.length === 0) prContainer.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:20px">Sin registros</div>';
    else sortedExercises.forEach(exName => { prContainer.innerHTML += `<div class="pr-row"><span class="pr-name">${exName}</span><span class="pr-value">üèÖ ${maxLifts[exName]} kg</span></div>`; });
}

function renderStats(){
    const h=JSON.parse(localStorage.getItem('pro_tracker_db'))||[];
    document.getElementById('total-sessions').innerText=h.length;
    const goal = ROUTINES.config_app ? ROUTINES.config_app.goal : 78;
    document.getElementById('goal-weight-display').innerHTML = `${goal} kg`;
    const w=localStorage.getItem('user_weight_current');
    if(w) document.getElementById('current-weight-display').innerText=w+' kg';
    const p=h.some(x=>!x.synced)||(JSON.parse(localStorage.getItem('weight_log'))||[]).some(x=>!x.synced);
    updateSyncUI(p?'pending':'synced');
}

function toggleHistoryView(view) {
    historyViewMode = view;
    document.getElementById('view-timeline-btn').className = view === 'timeline' ? 'active' : '';
    document.getElementById('view-calendar-btn').className = view === 'calendar' ? 'active' : '';
    document.getElementById('history-timeline-view').className = view === 'timeline' ? '' : 'hidden';
    document.getElementById('history-calendar-view').className = view === 'calendar' ? '' : 'hidden';
    if(view === 'timeline') renderTimeline(); else renderCalendar();
}

function renderTimeline(){
    const h = JSON.parse(localStorage.getItem('pro_tracker_db')) || [];
    const list = document.getElementById('history-list'); list.innerHTML = '';
    if(!h.length){ list.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:40px">Sin historial</div>'; return; }
    const sorted = [...h].sort((a,b) => b.id - a.id);
    sorted.forEach(s => {
        const dateObj = new Date(s.isoDate);
        const dayName = ['Dom','Lun','Mar','Mie','Jue','Vie','Sab'][dateObj.getDay()];
        const dayNum = dateObj.getDate();
        const month = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'][dateObj.getMonth()];
        const dateStr = `${dayName}, ${dayNum} ${month}`;
        
        let detailsHTML = `<div style="font-size:11px;color:#fbbf24;margin-bottom:8px">üî• ${s.warmup || 'Sin calentamiento'}</div>`;
        s.data.forEach(ex => {
            detailsHTML += `<div style="margin-top:8px"><div class="hist-ex-title">${ex.name}</div>`;
            ex.sets.forEach((set,i) => {
                let inf = ex.type==='weighted'?`${set.kg}kg √ó ${set.reps}`:ex.type==='time'?`${set.reps}`:`${set.reps} reps`;
                detailsHTML += `<div class="hist-set-row" style="border-bottom:1px solid rgba(255,255,255,0.05)"><span>#${i+1}</span><span>${inf}</span></div>`;
            });
            detailsHTML += `</div>`;
        });

        const syncIcon = s.synced ? '<i class="ri-cloud-check-line" style="color:var(--success)"></i>' : '<i class="ri-upload-cloud-line" style="color:var(--warning)"></i>';

        const item = document.createElement('div');
        item.className = 'card';
        item.style.border = '1px solid rgba(255,255,255,0.1)';
        item.style.marginBottom = '12px';
        
        item.innerHTML = `
            <div class="flex-between" style="border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:10px; margin-bottom:10px">
                <div>
                    <div style="font-size:12px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px">${dateStr}</div>
                    <strong style="font-size:16px; color:white">${s.title}</strong>
                </div>
                 <div style="display:flex; gap:15px; align-items:center">
                    ${syncIcon}
                    <button onclick="deleteItem(${s.id})" class="btn icon small" style="color:var(--danger); border:none; width:auto; height:auto; background:none; padding:0"><i class="ri-delete-bin-line" style="font-size:18px"></i></button>
                 </div>
            </div>
            <div>${detailsHTML}</div>
        `;
        list.appendChild(item);
    });
}

function renderCalendar(){
    const y=currentDate.getFullYear(),m=currentDate.getMonth();
    document.getElementById('cal-month-year').innerText=`${["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"][m]} ${y}`;
    const c=document.getElementById('cal-days-container');c.innerHTML='';
    const h=JSON.parse(localStorage.getItem('pro_tracker_db'))||[];
    const dates=h.map(x=>x.isoDate);
    const fd=new Date(y,m,1).getDay(),dim=new Date(y,m+1,0).getDate(),today=getLocalISO();
    for(let i=0;i<fd;i++)c.innerHTML+=`<div class="cal-day"></div>`;
    for(let d=1;d<=dim;d++){
        const iso=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        let cls=iso===today?'today':iso===selectedDateISO?'selected':'';
        if(dates.includes(iso)) cls+=' has-workout';
        c.innerHTML+=`<div class="cal-day ${cls}" onclick="selectDate('${iso}')">${d}</div>`;
    }
}
function changeMonth(d){currentDate.setMonth(currentDate.getMonth()+d);renderCalendar();}
function selectDate(iso){ 
    selectedDateISO=iso; renderCalendar(); 
    const h = JSON.parse(localStorage.getItem('pro_tracker_db')) || [];
    const items = h.filter(x => x.isoDate === iso);
    const container = document.getElementById('calendar-day-details'); container.innerHTML = '';
    if(items.length === 0) container.innerHTML = '<div style="text-align:center; color:var(--text-muted); font-size:12px; margin-top:20px">Sin actividad este d√≠a</div>';
    items.forEach(s => { 
        let detailsHTML = `<div style="font-size:11px;color:#fbbf24;margin-bottom:8px">üî• ${s.warmup || 'Sin calentamiento'}</div>`;
        s.data.forEach(ex => {
            detailsHTML += `<div style="margin-top:8px"><div class="hist-ex-title">${ex.name}</div>`;
            ex.sets.forEach((set,i) => {
                let inf = ex.type==='weighted'?`${set.kg}kg √ó ${set.reps}`:ex.type==='time'?`${set.reps}`:`${set.reps} reps`;
                detailsHTML += `<div class="hist-set-row" style="border-bottom:1px solid rgba(255,255,255,0.05)"><span>#${i+1}</span><span>${inf}</span></div>`;
            });
            detailsHTML += `</div>`;
        });
        container.innerHTML += `<div class="card" style="border:1px solid var(--primary-glow); margin-top:10px; animation: slideDown 0.3s"><div class="flex-between" style="border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:8px; margin-bottom:8px"><strong>${s.title}</strong><button onclick="deleteItem(${s.id})" class="btn icon small" style="color:var(--danger);border:none;background:none;padding:0"><i class="ri-delete-bin-line" style="font-size:18px"></i></button></div><div>${detailsHTML}</div></div>`; 
    });
}
async function deleteItem(id) { 
    if(!confirm("¬øBorrar?")) return;
    let h=JSON.parse(localStorage.getItem('pro_tracker_db'))||[]; h=h.filter(x=>x.id!==id); 
    localStorage.setItem('pro_tracker_db',JSON.stringify(h)); 
    if(historyViewMode === 'timeline') renderTimeline(); else { renderCalendar(); selectDate(selectedDateISO); }
    renderStats(); 
    if(navigator.onLine && !API_URL.includes("GOOGLE")) { try { await fetch(API_URL,{method:'POST',mode:'no-cors',body:JSON.stringify({action:'delete_workout',id:id})}); } catch(e){} } 
    showToast("Eliminado");
}

function cancelWorkout(){go('home');} function resetApp(){if(confirm("¬øReset de f√°brica?")){localStorage.clear();location.reload();}}

renderStats(); renderRoutinesHome();
</script>
</body>
</html>